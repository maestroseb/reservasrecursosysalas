<script>
  /* ========================================
   ADMIN PANEL - JAVASCRIPT ORGANIZADO
   
   ðŸ“‹ MÃ“DULOS ORDENADOS POR FRECUENCIA DE USO:
   1. Reservas (uso frecuente)
   2. Recursos (uso moderado)
   3. Disponibilidad (uso moderado)
   4. Usuarios (uso ocasional)
   5. Cursos (configuraciÃ³n anual)
   6. Tramos (configuraciÃ³n anual)
   7. Config (configuraciÃ³n inicial)
   
   ðŸ’¡ RAZÃ“N: Optimizado para debugging diario
   ======================================== */

/* ==========================================
   1ï¸âƒ£ ESTADO GLOBAL Y CONFIGURACIÃ“N
   ========================================== */

const AdminState = {
  recursos: [],
  tramos: [],
  disponibilidad: [],
  cursos: [],
  usuarios: [],
  reservas: [],
  solicitudesRecurrentes: [],
  modoVisualizacionCursos: 'botones',
  currentRecurso: null,
  isEditMode: false,
  tipoFiltroActivo: '', // '' = Todas, 'Sala', 'Dispositivo', 'Agrupado'
  cambiosPendientes: false, // Indica si hay cambios sin guardar
  ordenOriginal: {} // Guarda el orden original para detectar cambios
};

let adminHaCambiadoDatos = false; // Flag para saber si hay que recargar al volver

/* ==========================================
   2ï¸âƒ£ UTILIDADES COMPARTIDAS
   ========================================== */

// FunciÃ³n segura para evitar inyecciones de cÃ³digo y errores visuales
window.escaparHTML = (str) => {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
};

/* LÃ“GICA DE CONFIRMACIÃ“N (MODAL INTELIGENTE) */
let accionConfirmadaCallback = null;

function mostrarConfirmacion(titulo, mensaje, callbackAccion) {
  const modal = document.getElementById('modalConfirmacion');
  
  // ðŸ›‘ FIX: ESCAPE DE PRISIÃ“N (La magia estÃ¡ aquÃ­)
  // Si el modal estÃ¡ atrapado dentro de una pestaÃ±a, lo movemos al body
  // para que se centre correctamente en medio de la ventana visible.
  if (modal && modal.parentNode !== document.body) {
    document.body.appendChild(modal);
  }
  
  // 1. Configurar Textos
  document.getElementById('confirmTitle').innerText = titulo;
  document.getElementById('confirmMessage').innerHTML = mensaje;
  
  // 2. Guardar acciÃ³n
  accionConfirmadaCallback = callbackAccion;
  
  // 3. Configurar BotÃ³n Confirmar (Clonamos para limpiar eventos viejos)
  const btn = document.getElementById('btnConfirmarAccion');
  const newBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn, btn);
  
  newBtn.addEventListener('click', function() {
    if (accionConfirmadaCallback) accionConfirmadaCallback();
    cerrarConfirmacion();
  });

  // 4. Mostrar
  modal.classList.remove('hidden');
}

function cerrarConfirmacion() {
  const modal = document.getElementById('modalConfirmacion');
  if (modal) modal.classList.add('hidden');
  accionConfirmadaCallback = null;
}

/* ==========================================================================
   3ï¸âƒ£ SISTEMA CORE UI: SISTEMA CENTRAL DE GUARDADO (FINAL ðŸ’Ž)
   ========================================================================== */

// --- 1. GESTOR DE BARRA DE GUARDADO (FIX MÃ“VIL + COLCHÃ“N DE AIRE â˜ï¸) ---
const SaveBarManager = {
  show: function(subtitle, onSave, onDiscard) {
    const bar = document.getElementById('globalSaveBar');
    if(!bar) return;

    // Fix Sticky: Mover al body si estÃ¡ atrapado
    if (bar.parentNode !== document.body) {
      document.body.appendChild(bar);
    }

    const btnSave = document.getElementById('btnGlobalSave');
    const btnDiscard = document.getElementById('btnGlobalDiscard');
    const subLabel = document.getElementById('saveBarSubtitle');

    // 1. TEXTO (Solo si cambia)
    if (subLabel && subLabel.textContent !== subtitle) {
        subLabel.textContent = subtitle;
    }

    // 2. ACCIONES (Sin recrear botones para evitar parpadeo)
    if(btnSave) btnSave.onclick = (e) => { e.preventDefault(); onSave(); };
    if(btnDiscard) btnDiscard.onclick = (e) => { e.preventDefault(); onDiscard(); };

    // 3. MOSTRAR + COLCHÃ“N
    if (!bar.classList.contains('translate-y-0')) {
        bar.classList.remove('translate-y-32', 'opacity-0', 'pointer-events-none');
        bar.classList.add('translate-y-0', 'opacity-100', 'pointer-events-auto');
        
        // ðŸ”¥ Padding extra al body para que la barra no tape el final de la tabla en mÃ³vil
        document.body.classList.add('pb-32'); 
    }
  },

  hide: function() {
    const bar = document.getElementById('globalSaveBar');
    if(bar) {
      if (bar.classList.contains('translate-y-0')) {
          bar.classList.remove('translate-y-0', 'opacity-100', 'pointer-events-auto');
          bar.classList.add('translate-y-32', 'opacity-0', 'pointer-events-none');
          
          // ðŸ”¥ Quitamos el padding extra
          document.body.classList.remove('pb-32');

          const btnSave = document.getElementById('btnGlobalSave');
          const btnDiscard = document.getElementById('btnGlobalDiscard');
          if(btnSave) btnSave.onclick = null;
          if(btnDiscard) btnDiscard.onclick = null;
      }
    }
  }
};

// Exponer globalmente
window.showToast = showToast;
window.hideToast = hideToast;
window.SaveBarManager = SaveBarManager;


// ========================================
// 4ï¸âƒ£ DATOS ESTÃTICOS: BASE DE DATOS DE ICONOS ICONIFY
// ========================================

const ICONIFY_ICONS = {
  tecnologia: [
    { icon: 'mdi:laptop', name: 'PortÃ¡til' },
    { icon: 'mdi:desktop-tower', name: 'Ordenador' },
    { icon: 'mdi:keyboard', name: 'Teclado' },
    { icon: 'mdi:mouse', name: 'RatÃ³n' },
    { icon: 'mdi:printer', name: 'Impresora' },
    { icon: 'mdi:printer-3d', name: 'Impresora 3D' },
    { icon: 'mdi:cellphone', name: 'MÃ³vil' },
    { icon: 'mdi:tablet', name: 'Tablet' },
    { icon: 'simple-icons:arduino', name: 'Arduino' },
    { icon: 'simple-icons:raspberrypi', name: 'Raspberry Pi' },
    { icon: 'simple-icons:microbit', name: 'Micro:bit' },
    { icon: 'mdi:robot', name: 'Robot' },
    { icon: 'carbon:3d-print-mesh', name: 'ImpresiÃ³n 3D' },
    { icon: 'mdi:router-wireless', name: 'Router' },
    { icon: 'mdi:projector', name: 'Proyector' }
  ],
  
  ciencias: [
    { icon: 'mdi:microscope', name: 'Microscopio' },
    { icon: 'mdi:telescope', name: 'Telescopio' },
    { icon: 'carbon:chemistry', name: 'QuÃ­mica' },
    { icon: 'mdi:flask', name: 'Matraz' },
    { icon: 'mdi:test-tube', name: 'Tubo ensayo' },
    { icon: 'mdi:dna', name: 'ADN' },
    { icon: 'carbon:chemistry-reference', name: 'Lab. QuÃ­mica' },
    { icon: 'mdi:atom', name: 'Ãtomo' },
    { icon: 'carbon:earth', name: 'Tierra' },
    { icon: 'mdi:molecule', name: 'MolÃ©cula' },
    { icon: 'carbon:microscope', name: 'Lab. BiologÃ­a' },
    { icon: 'mdi:bacteria', name: 'Bacteria' }
  ],
  
  deportes: [
    { icon: 'mdi:soccer', name: 'FÃºtbol' },
    { icon: 'mdi:basketball', name: 'Baloncesto' },
    { icon: 'mdi:volleyball', name: 'Voleibol' },
    { icon: 'mdi:tennis', name: 'Tenis' },
    { icon: 'mdi:table-tennis', name: 'Ping pong' },
    { icon: 'mdi:badminton', name: 'BÃ¡dminton' },
    { icon: 'mdi:dumbbell', name: 'Gimnasio' },
    { icon: 'mdi:weight-lifter', name: 'Pesas' },
    { icon: 'mdi:run', name: 'Atletismo' },
    { icon: 'mdi:swim', name: 'NataciÃ³n' },
    { icon: 'mdi:yoga', name: 'Yoga' },
    { icon: 'carbon:basketball', name: 'Cancha' }
  ],
  
  arte: [
    { icon: 'mdi:palette', name: 'Paleta' },
    { icon: 'mdi:brush', name: 'Pincel' },
    { icon: 'mdi:draw', name: 'Dibujo' },
    { icon: 'mdi:music', name: 'MÃºsica' },
    { icon: 'mdi:piano', name: 'Piano' },
    { icon: 'mdi:guitar-acoustic', name: 'Guitarra' },
    { icon: 'mdi:microphone', name: 'MicrÃ³fono' },
    { icon: 'mdi:violin', name: 'ViolÃ­n' },
    { icon: 'mdi:drama-masks', name: 'Teatro' },
    { icon: 'mdi:camera', name: 'FotografÃ­a' },
    { icon: 'mdi:video', name: 'VÃ­deo' },
    { icon: 'carbon:music', name: 'Sala mÃºsica' }
  ],
  
  biblioteca: [
    { icon: 'mdi:book-open-page-variant', name: 'Libro abierto' },
    { icon: 'mdi:book-multiple', name: 'Libros' },
    { icon: 'mdi:bookshelf', name: 'EstanterÃ­a' },
    { icon: 'mdi:library', name: 'Biblioteca' },
    { icon: 'mdi:book-education', name: 'EducaciÃ³n' },
    { icon: 'mdi:notebook', name: 'Cuaderno' },
    { icon: 'carbon:book', name: 'Libro' },
    { icon: 'mdi:magazine', name: 'Revista' }
  ],
  
  idiomas: [
    { icon: 'mdi:translate', name: 'TraducciÃ³n' },
    { icon: 'mdi:earth', name: 'Mundo' },
    { icon: 'carbon:globe', name: 'Global' },
    { icon: 'mdi:comment-text', name: 'ConversaciÃ³n' },
    { icon: 'mdi:alphabet-latin', name: 'Alfabeto' },
    { icon: 'carbon:language', name: 'Idiomas' }
  ],
  
  naturaleza: [
    { icon: 'mdi:flower', name: 'Flor' },
    { icon: 'mdi:tree', name: 'Ãrbol' },
    { icon: 'mdi:leaf', name: 'Hoja' },
    { icon: 'carbon:tree', name: 'Bosque' },
    { icon: 'mdi:recycle', name: 'Reciclaje' },
    { icon: 'mdi:sprout', name: 'Brote' },
    { icon: 'carbon:plant', name: 'Planta' },
    { icon: 'mdi:water', name: 'Agua' }
  ],
  
  espacios: [
    { icon: 'mdi:school', name: 'Escuela' },
    { icon: 'mdi:office-building', name: 'Edificio' },
    { icon: 'mdi:door', name: 'Sala' },
    { icon: 'mdi:sofa', name: 'Sala estar' },
    { icon: 'carbon:cafe', name: 'CafeterÃ­a' },
    { icon: 'mdi:table-chair', name: 'Comedor' },
    { icon: 'carbon:building', name: 'InstalaciÃ³n' },
    { icon: 'mdi:home', name: 'Casa' },
    { icon: 'mdi:map-marker', name: 'UbicaciÃ³n' },
    { icon: 'carbon:education', name: 'Aula' }
  ],
  
  ocio: [
    { icon: 'mdi:gamepad-variant', name: 'Videojuegos' },
    { icon: 'mdi:chess-king', name: 'Ajedrez' },
    { icon: 'mdi:puzzle', name: 'Puzzle' },
    { icon: 'mdi:cards', name: 'Cartas' },
    { icon: 'mdi:dice-multiple', name: 'Juegos mesa' },
    { icon: 'carbon:game-console', name: 'Consola' },
    { icon: 'mdi:toy-brick', name: 'ConstrucciÃ³n' },
    { icon: 'mdi:cog', name: 'Taller' }
  ]
};


/* ==========================================
   5ï¸âƒ£ INICIALIZACIÃ“N DE LISTENERS (MASTER MIX ðŸŽ§)
   ========================================== */

function setupAdminListeners() {

  // 1. RECUPERAMOS TUS FIXES VISUALES ANTIGUOS
  if (typeof fixMenusFlotantes === 'function') fixMenusFlotantes();
  
  // 2. INICIALIZAR COMPONENTES EXTERNOS (Iconify, etc.)
  if (typeof setupIconifySelector === 'function') setupIconifySelector(); // Si usas la versiÃ³n antigua
  // Si usas mi versiÃ³n nueva de iconos, no hace falta llamar a nada aquÃ­, va solo.

  // 3. GESTIÃ“N DE TABS (PESTAÃ‘AS)
  const tabs = document.querySelectorAll('.admin-subtab');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      // --- A. GESTIÃ“N VISUAL ---
      // 1. Quitar active a todos los botones
      tabs.forEach(t => t.classList.remove('active'));
      // 2. Ocultar todas las secciones
      document.querySelectorAll('.admin-section').forEach(sec => {
        sec.classList.add('hidden');
        sec.classList.remove('active'); // Por si acaso usabas esta clase
      });
      
      // 3. Activar botÃ³n actual
      tab.classList.add('active');
      
      // 4. Mostrar secciÃ³n actual
      const sectionName = tab.getAttribute('data-section');
      const targetSection = document.getElementById(`admin-section-${sectionName}`);
      
      if (targetSection) {
        targetSection.classList.remove('hidden');
        targetSection.classList.add('active');
      } else {
        console.error(`âŒ No existe la secciÃ³n: admin-section-${sectionName}`);
        return;
      }

      // --- B. RENDERIZADO DE DATOS (Carga lo que toca) ---
      
      try {
        if (sectionName === 'recursos') renderTablaRecursos();
        
        if (sectionName === 'tramos') renderTablaTramos();
        
        if (sectionName === 'disponibilidad') {
            if(typeof DispState !== 'undefined' && DispState.recursoId) {
                cargarMatrizDisponibilidad(DispState.recursoId);
            } else {
                // Si es la primera vez, renderizamos el selector vacÃ­o o inicial
                if(typeof renderSelectRecursos === 'function') renderSelectRecursos();
            }
        }
        
        if (sectionName === 'cursos') {
             if (typeof inicializarCursos === 'function') inicializarCursos();
             else renderTablaCursos();
        }
        
        if (sectionName === 'usuarios') renderTablaUsuarios();
        
        if (sectionName === 'reservas') {
             if(typeof renderTablaReservas === 'function') renderTablaReservas();
        }
        
        if (sectionName === 'config') renderConfiguracion();

        if (sectionName === 'recurrentes') {
          if (typeof cargarSolicitudesRecurrentes === 'function') cargarSolicitudesRecurrentes();
        }

      } catch (err) {
        console.error(`âŒ Error pintando ${sectionName}:`, err);
      }
    });
  });

  // 4. BUSCADORES
  const searchCursos = document.getElementById('buscadorCursos');
  if (searchCursos) {
    searchCursos.addEventListener('input', (e) => {
       if(typeof filtrarCursos === 'function') filtrarCursos(e.target.value);
    });
  }
}

/* ==========================================
   6ï¸âƒ£ MÃ“DULOS DE GESTIÃ“N
   ========================================== */

/* ==========================================
   6.1. GESTIÃ“N DE RESERVAS (OPTIMIZADO V3 - FINAL ðŸŽ¯)
   ========================================== */

// --- 1. HELPERS SEGUROS (Locales para evitar conflictos) ---

// Limpiador de HTML para evitar inyecciones (XSS)
const safeHtmlRes = (str) => {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#039;');
};

// Extractor de nÃºmero de tramo (Usa el global si existe, sino usa este local)
const getTramoNum = (idTramo) => {
  if (typeof window.extraerNumeroTramo === 'function') {
    return window.extraerNumeroTramo(idTramo);
  }
  // Fallback local por si acaso
  const match = String(idTramo || '').match(/\d+/);
  return match ? parseInt(match[0], 10) : 999;
};

// --- 2. INICIALIZACIÃ“N ---
function inicializarReservas() {
  // ValidaciÃ³n robusta
  if (!AdminState || !AdminState.reservas) return;
  
  console.log('ðŸ“š Inicializando Reservas...');
  
  // Renderizar la tabla por primera vez
  renderTablaReservas();
}

// --- 3. RENDERIZADO PRINCIPAL ---
function renderTablaReservas() {
  const tbody = document.getElementById('tablaReservasBody');
  if (!tbody) return;

  // Si no hay datos, mostrar mensaje vacÃ­o
  if (!AdminState.reservas || AdminState.reservas.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center py-12 text-gray-400 italic">No hay reservas registradas</td></tr>`;
    document.getElementById('totalReservasCount').innerText = '0';
    return;
  }

  // ðŸ”¥ TRUCO PRO: Guardar la posiciÃ³n del scroll antes de borrar la tabla
  // Buscamos el contenedor padre que tiene el scroll (habitualmente el div que envuelve la tabla)
  const scrollContainer = tbody.closest('.overflow-auto') || tbody.parentElement;
  const prevScrollTop = scrollContainer ? scrollContainer.scrollTop : 0;

  // Limpiar tabla
  tbody.innerHTML = '';
  
  // Obtener filtro
  const filtro = document.getElementById('buscadorReservas')?.value.toLowerCase() || '';

  // --- A. PREPARACIÃ“N DE MAPAS (OptimizaciÃ³n O(1)) ---
  const usuariosMap = {};
  (AdminState.usuarios || []).forEach(u => {
    const email = String(u.Email || u.Email_Usuario || '').toLowerCase();
    if (email) usuariosMap[email] = u.Nombre || u.Nombre_Completo || u.Email_Usuario;
  });

  const recursosMap = {};
  (AdminState.recursos || []).forEach(r => {
    const id = String(r.id_recurso || r.ID_Recurso || '').toLowerCase();
    if (id) recursosMap[id] = r.nombre_recurso || r.Nombre || r.nombre || r.ID_Recurso;
  });

  // --- B. PROCESADO Y FILTRADO ---
  const hoyStr = new Date().toISOString().split('T')[0];

  const lista = AdminState.reservas
    .map(reserva => {
      const emailKey = String(reserva.Email_Usuario || '').toLowerCase();
      const recursoKey = String(reserva.ID_Recurso || '').toLowerCase();

      return {
        ...reserva,
        // Usamos los mapas para obtener nombres bonitos
        nombreUsuario: usuariosMap[emailKey] || reserva.Email_Usuario || 'Desconocido',
        nombreRecurso: recursosMap[recursoKey] || reserva.ID_Recurso || 'Recurso eliminado'
      };
    })
    .filter(r => {
      if (!filtro) return true;
      // BÃºsqueda en todos los campos relevantes
      return (
        String(r.nombreUsuario).toLowerCase().includes(filtro) ||
        String(r.Email_Usuario).toLowerCase().includes(filtro) ||
        String(r.nombreRecurso).toLowerCase().includes(filtro) ||
        String(r.Fecha).toLowerCase().includes(filtro) ||
        String(r.Estado).toLowerCase().includes(filtro)
      );
    });

  // --- C. ORDENACIÃ“N MULTINIVEL ---
  lista.sort((a, b) => {
    const aFecha = a.Fecha || '';
    const bFecha = b.Fecha || '';
    const aEstado = (a.Estado || 'Confirmada').toLowerCase();
    const bEstado = (b.Estado || 'Confirmada').toLowerCase();
    
    const aEsPasado = aFecha < hoyStr;
    const bEsPasado = bFecha < hoyStr;
    const aEsCancelada = aEstado === 'cancelada';
    const bEsCancelada = bEstado === 'cancelada';
    
    // 1. Prioridad por Estado (Activas > Canceladas > Pasadas)
    const aCat = aEsPasado ? 2 : (aEsCancelada ? 1 : 0);
    const bCat = bEsPasado ? 2 : (bEsCancelada ? 1 : 0);
    if (aCat !== bCat) return aCat - bCat;
    
    // 2. Fecha (MÃ¡s reciente primero)
    if (bFecha !== aFecha) return bFecha > aFecha ? 1 : -1;
    
    // 3. Recurso (AlfabÃ©tico)
    const aRecurso = (a.nombreRecurso || '').toLowerCase();
    const bRecurso = (b.nombreRecurso || '').toLowerCase();
    if (aRecurso !== bRecurso) return aRecurso.localeCompare(bRecurso);
    
    // 4. Tramo (NumÃ©rico usando el helper seguro)
    return getTramoNum(a.ID_Tramo) - getTramoNum(b.ID_Tramo);
  });

  // Actualizar contador visual
  const countSpan = document.getElementById('totalReservasCount');
  if(countSpan) countSpan.innerText = lista.length;

  if (lista.length === 0) {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center py-12 text-gray-400 bg-gray-50/50 italic">No hay coincidencias con la bÃºsqueda</td></tr>`;
    return;
  }

  // --- D. RENDERIZADO DOM (DocumentFragment) ---
  const fragment = document.createDocumentFragment();

  lista.forEach(reserva => {
    const tr = document.createElement('tr');
    const esPasado = (reserva.Fecha || '') < hoyStr;
    const estado = reserva.Estado || 'Confirmada';
    
    // Clases dinÃ¡micas
    tr.className = `group hover:bg-blue-50/30 transition-all border-b border-gray-100 ${esPasado ? 'opacity-60 grayscale-[0.8]' : ''}`;

    // Fecha formateada (YYYY-MM-DD -> DD/MM/YYYY)
    const fechaEsp = (reserva.Fecha && reserva.Fecha.includes('-')) 
      ? reserva.Fecha.split('-').reverse().join('/') 
      : reserva.Fecha;

    // Badges de Estado
    let badgeClass = 'bg-emerald-100 text-emerald-700 border-emerald-200';
    let iconState = 'mdi:check-circle-outline';
    
    if(estado === 'Cancelada') { 
        badgeClass = 'bg-red-50 text-red-600 border-red-100'; 
        iconState = 'mdi:close-circle-outline'; 
    } else if(estado === 'Pendiente') { 
        badgeClass = 'bg-amber-50 text-amber-700 border-amber-100'; 
        iconState = 'mdi:clock-outline'; 
    }

    // Datos sanitizados para HTML
    const idReservaSafe = safeHtmlRes(reserva.ID_Reserva);
    const nombreRecursoSafe = safeHtmlRes(reserva.nombreRecurso);
    const nombreUsuarioSafe = safeHtmlRes(reserva.nombreUsuario);
    const emailSafe = safeHtmlRes(reserva.Email_Usuario);
    const cursoSafe = safeHtmlRes(reserva.Curso);
    const tramoSafe = safeHtmlRes(reserva.ID_Tramo);

    // Template HTML
    tr.innerHTML = `
      <td class="px-6 py-4 whitespace-nowrap">
         <div class="flex flex-col">
            <span class="text-sm font-bold text-gray-800 flex items-center gap-2">
               <iconify-icon icon="mdi:calendar-month" class="text-gray-400"></iconify-icon> ${fechaEsp}
            </span>
            <span class="text-xs text-gray-500 ml-6 font-mono bg-gray-100 px-1.5 py-0.5 rounded w-fit">
               ${tramoSafe}
            </span>
         </div>
      </td>

      <td class="px-6 py-4">
         <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-lg bg-blue-50 text-blue-600 flex items-center justify-center shrink-0 shadow-sm border border-blue-100">
               <iconify-icon icon="mdi:cube-outline" width="18"></iconify-icon>
            </div>
            <div class="flex flex-col min-w-0">
               <span class="text-sm font-semibold text-gray-700 truncate max-w-[150px]" title="${nombreRecursoSafe}">${nombreRecursoSafe}</span>
               <span class="text-[10px] text-gray-400 uppercase tracking-wider">${safeHtmlRes(reserva.ID_Recurso)}</span>
            </div>
         </div>
      </td>

      <td class="px-6 py-4">
         <div class="flex flex-col min-w-0">
            <span class="text-sm font-medium text-gray-900 truncate max-w-[180px]" title="${nombreUsuarioSafe}">${nombreUsuarioSafe}</span>
            <span class="text-xs text-gray-500 truncate">${emailSafe}</span>
            ${reserva.Curso ? `<span class="text-[10px] font-bold text-gray-500 bg-gray-100 border border-gray-200 px-1.5 py-0.5 rounded w-fit mt-1">${cursoSafe}</span>` : ''}
         </div>
      </td>
      
      <td class="px-4 py-4 whitespace-nowrap text-center">
         <span class="font-mono text-sm font-bold bg-gray-50 text-gray-600 px-2 py-1 rounded border border-gray-200">
            ${parseInt(reserva.Cantidad) || 1}
         </span>
      </td>

      <td class="px-6 py-4 whitespace-nowrap text-center">
        <span class="px-2.5 py-1 rounded-full text-xs font-semibold border inline-flex items-center gap-1.5 ${badgeClass}">
          <iconify-icon icon="${iconState}"></iconify-icon>
          ${safeHtmlRes(estado)}
        </span>
      </td>

      <td class="px-6 py-4 whitespace-nowrap text-right">
        ${!esPasado && estado !== 'Cancelada' ? `
          <button onclick="cancelarReserva('${idReservaSafe}')" 
                  class="group/btn relative overflow-hidden bg-white text-red-500 hover:text-red-600 hover:bg-red-50 border border-red-200 hover:border-red-300 rounded-lg px-3 py-1.5 transition-all shadow-sm active:scale-95 flex items-center gap-1.5 ml-auto text-xs font-bold">
            <iconify-icon icon="mdi:delete-outline" width="16"></iconify-icon>
            <span>Cancelar</span>
          </button>
        ` : ''}
      </td>
    `;
    fragment.appendChild(tr);
  });
  
  tbody.appendChild(fragment);

  // ðŸ”¥ RESTAURAR SCROLL: Devolver al usuario a donde estaba
  if (scrollContainer) {
    scrollContainer.scrollTop = prevScrollTop;
  }
}

// --- 4. ACCIÃ“N: CANCELAR RESERVA ---
function cancelarReserva(idReserva) {
  mostrarConfirmacion(
    'Â¿Cancelar esta reserva?', 
    'Esta acciÃ³n liberarÃ¡ el recurso y notificarÃ¡ al usuario.',
    function() {
      showLoading();
      
      google.script.run
        .withSuccessHandler(res => {
          hideLoading();
          
          if (res.success) {
            // --- ACTUALIZACIÃ“N OPTIMISTA ---
            const index = AdminState.reservas.findIndex(r => String(r.ID_Reserva) === String(idReserva));
            
            if (index !== -1) {
                // Actualizamos el dato localmente
                AdminState.reservas[index].Estado = 'Cancelada';
                
                // Repintamos la tabla (que ahora mantendrÃ¡ el scroll)
                renderTablaReservas();
                
                showToast('success', 'Reserva cancelada correctamente');
            } else {
                // Si no se encuentra (raro), recargamos todo
                if (typeof loadAdminData === 'function') loadAdminData();
            }

          } else {
            showToast('error', res.error || 'Error al cancelar');
          }
        })
        .withFailureHandler(err => {
          hideLoading();
          showToast('error', 'Error de conexiÃ³n: ' + err);
        })
        .adminCancelarReserva(idReserva);
    }
  );
}

// EXPORTS GLOBALES
window.inicializarReservas = inicializarReservas;
window.renderTablaReservas = renderTablaReservas;
window.cancelarReserva = cancelarReserva;


/* =========================================================
   6.2. GESTIÃ“N DE RECURSOS (V4 - CIRUGÃA FINA & NO-RERENDER ðŸ©º)
   ========================================================= */

// --- 1. CONSTANTES Y CONFIGURACIÃ“N ---

const TIPO_OPTIONS = {
  'Sala':        { label: 'Sala',        icon: 'mdi:door-open',    color: 'text-indigo-600', bg: 'bg-indigo-50' },
  'Dispositivo': { label: 'Dispositivo', icon: 'mdi:laptop',       color: 'text-purple-600', bg: 'bg-purple-50' },
  'Agrupado':    { label: 'Agrupado',    icon: 'mdi:group',        color: 'text-orange-600', bg: 'bg-orange-50' }
};

const ESTADO_OPTIONS = {
  'Activo':        { label: 'Activo',        color: 'text-green-700',  bg: 'bg-green-100', border: 'border-green-200', hover: 'hover:bg-green-50' },
  'Inactivo':      { label: 'Inactivo',      color: 'text-gray-500',   bg: 'bg-gray-100',  border: 'border-gray-200',  hover: 'hover:bg-gray-50' },
  'Mantenimiento': { label: 'Mantenimiento', color: 'text-yellow-700', bg: 'bg-yellow-100', border: 'border-yellow-200', hover: 'hover:bg-yellow-50' }
};

// Generador de ID y Limpiador HTML
const generateId = () => 'REC-' + Math.random().toString(36).slice(2, 7).toUpperCase();
const safeHtmlRec = (str) => String(str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

// --- 2. INICIALIZACIÃ“N ---
function inicializarRecursos() {
  if (!AdminState.recursos) return;
  
  // Clonamos los datos para tener la referencia "limpia"
  // Importante: Esto define el punto cero para saber si hay cambios
  AdminState.recursosOriginales = JSON.parse(JSON.stringify(AdminState.recursos));
  AdminState.cambiosPendientes = false;
  
  renderTablaRecursos();
}

// --- 3. RENDERIZADO PRINCIPAL ---
function renderTablaRecursos() {
  const tbody = document.getElementById('tablaRecursosBody');
  if (!tbody) return;
  
  // Preservar scroll
  const scrollContainer = tbody.closest('.overflow-auto') || tbody.parentElement;
  const prevScrollTop = scrollContainer ? scrollContainer.scrollTop : 0;

  tbody.innerHTML = '';

  if (!AdminState.recursos || AdminState.recursos.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8" class="text-center py-12 text-gray-500 bg-gray-50/50 italic border-2 border-dashed border-gray-100 rounded-lg m-4">âœ¨ No hay recursos. Crea el primero arriba.</td></tr>`;
    return;
  }

  const fragment = document.createDocumentFragment();
  const tiposKeys = Object.keys(TIPO_OPTIONS);
  const estadosKeys = Object.keys(ESTADO_OPTIONS);

  AdminState.recursos.forEach((recurso, index) => {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-50 transition-colors border-b border-gray-100 group bg-white draggable-row';
    tr.setAttribute('draggable', 'true');
    tr.dataset.index = index;

    // Datos actuales
    const tipo = recurso.tipo || 'Dispositivo';
    const estado = recurso.estado || 'Activo';
    const tipoInfo = TIPO_OPTIONS[tipo] || TIPO_OPTIONS['Dispositivo'];
    const estadoInfo = ESTADO_OPTIONS[estado] || ESTADO_OPTIONS['Activo'];
    
    // ValidaciÃ³n visual
    const nombreClass = recurso.nombre 
        ? "border-transparent hover:border-gray-300 focus:border-blue-500" 
        : "border-red-300 bg-red-50 focus:border-red-500 placeholder-red-400";

    // --- HTML DROPDOWNS ---
    const dropdownTipoHTML = tiposKeys.map(key => {
      const opt = TIPO_OPTIONS[key];
      return `<div onclick="event.stopPropagation(); actualizarDropdownRecurso(${index}, 'tipo', '${key}')" 
                   class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer border-b border-gray-50 last:border-0 group/opt">
        <iconify-icon icon="${opt.icon}" class="${opt.color} group-hover/opt:scale-110 transition-transform"></iconify-icon>
        <span class="text-xs text-gray-600">${opt.label}</span>
      </div>`;
    }).join('');

    const dropdownEstadoHTML = estadosKeys.map(key => {
      const opt = ESTADO_OPTIONS[key];
      return `<div onclick="event.stopPropagation(); actualizarDropdownRecurso(${index}, 'estado', '${key}')" 
                   class="px-4 py-2.5 cursor-pointer border-b border-gray-50 last:border-0 text-xs font-bold flex items-center gap-2 transition-colors ${opt.hover}">
        <span class="${opt.color} whitespace-nowrap">${opt.label}</span>
      </div>`;
    }).join('');

    tr.innerHTML = `
      <td class="px-2 pt-2 pb-4 text-center cursor-grab text-gray-300 hover:text-blue-600 active:cursor-grabbing handle w-10 min-w-[40px] align-center">
         <div class="flex items-center justify-center min-h-[40px] pt-2">
            <iconify-icon icon="mdi:drag-horizontal-variant" width="24"></iconify-icon>
         </div>
      </td>

      <td class="px-2 py-4 text-center w-16 min-w-[50px] align-center">
         <div class="flex items-center justify-center min-h-[40px]">
            <button onclick="abrirSelectorIconos(${index})"
                    class="h-10 w-10 rounded-xl bg-indigo-50 hover:bg-indigo-100 text-indigo-600 flex items-center justify-center transition-all border border-transparent hover:border-indigo-200 shadow-sm group-hover:scale-105">
               <iconify-icon icon="${recurso.icono || 'mdi:cube-outline'}" class="text-2xl"></iconify-icon>
            </button>
         </div>
      </td>

      <td class="px-2 py-4 align-center w-24 min-w-[120px]">
         <div class="flex items-center min-h-[40px]">
            <input type="text" value="${safeHtmlRec(recurso.id_recurso)}" 
                   class="font-mono text-xs text-blue-600 font-medium bg-gray-50 border border-gray-200 rounded-md px-2 py-1.5 w-full outline-none focus:border-blue-500 focus:bg-white transition-colors text-center"
                   placeholder="ID"
                   oninput="editarRecursoInput(this, ${index}, 'id_recurso')">
         </div>
      </td>

      <td class="px-4 py-2 align-center min-w-[260px]">
         <div class="flex flex-col gap-1"> 
            <input type="text" value="${safeHtmlRec(recurso.nombre)}" placeholder="Nombre del recurso *"
                   class="font-bold text-gray-800 text-sm w-full bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none transition-colors ${nombreClass}"
                   oninput="editarRecursoInput(this, ${index}, 'nombre')">
            
            <div class="relative flex items-center">
               <iconify-icon icon="mdi:map-marker-outline" class="absolute left-0 text-gray-400 text-xs pointer-events-none"></iconify-icon>
               <input type="text" value="${safeHtmlRec(recurso.ubicacion)}" placeholder="UbicaciÃ³n"
                      class="text-xs text-gray-500 w-full bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none pl-4 pb-0.5"
                      oninput="editarRecursoInput(this, ${index}, 'ubicacion')">
            </div>
         </div>
      </td>

      <td class="px-2 py-4 w-48 min-w-[150px] align-center relative">
         <div id="container-tipo-${index}" class="relative w-full transition-all"> 
            <button onclick="toggleDropdownRecurso(${index}, 'tipo', event)" 
                    class="w-full flex items-center gap-2 px-2 py-1.5 bg-white border border-gray-200 rounded-lg text-xs font-medium hover:border-blue-400 transition-colors shadow-sm text-left">
                
                <div id="preview-tipo-bg-${index}" class="p-1 rounded ${tipoInfo.bg} ${tipoInfo.color} leading-none">
                    <iconify-icon id="preview-tipo-icon-${index}" icon="${tipoInfo.icon}"></iconify-icon>
                </div>
                
                <span id="preview-tipo-text-${index}" class="flex-1 text-gray-700 truncate">${tipoInfo.label}</span>
                <iconify-icon icon="mdi:chevron-down" class="text-gray-400 ml-auto"></iconify-icon>
            </button>
            
            <div id="dropdown-tipo-${index}" class="hidden absolute top-full left-0 mt-1 w-full bg-white border border-gray-100 rounded-lg shadow-xl overflow-hidden animate-fade-in-up z-[60]">
                ${dropdownTipoHTML}
            </div>
         </div>
      </td>

      <td class="px-4 py-4 text-center w-20 min-w-[80px] align-center">
         <input type="number" value="${recurso.capacidad || 1}" min="1"
                class="w-16 text-center text-sm font-medium bg-gray-50 border border-gray-200 rounded-lg py-1.5 focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none shadow-sm transition-all"
                oninput="editarRecursoInput(this, ${index}, 'capacidad')">
      </td>

      <td class="px-4 py-4 text-center w-40 min-w-[140px] align-center relative">
         <div id="container-estado-${index}" class="relative w-full transition-all">
            <button id="btn-estado-main-${index}" 
                    onclick="toggleDropdownRecurso(${index}, 'estado', event)"
                    class="w-full text-xs font-bold px-3 py-1.5 rounded-full border shadow-sm transition-all flex items-center justify-center gap-1 whitespace-nowrap ${estadoInfo.bg} ${estadoInfo.color} ${estadoInfo.border} hover:opacity-90 active:scale-95">
                <span id="preview-estado-text-${index}">${estadoInfo.label}</span>
                <iconify-icon icon="mdi:chevron-down" class="opacity-50"></iconify-icon>
            </button>
            
            <div id="dropdown-estado-${index}" class="hidden absolute top-full left-0 right-0 mt-1 bg-white border border-gray-100 rounded-xl shadow-xl overflow-hidden animate-fade-in-up min-w-[140px] z-[60]">
                ${dropdownEstadoHTML}
            </div>
         </div>
      </td>

      <td class="px-4 py-4 text-right w-16 min-w-[64px] align-center">
         <button onclick="eliminarRecursoFila(${index})" 
                 class="text-gray-300 hover:text-red-600 p-2 rounded-xl hover:bg-red-50 transition-all opacity-100 sm:opacity-0 sm:group-hover:opacity-100"
                 title="Eliminar">
            <iconify-icon icon="mdi:trash-can-outline" width="20"></iconify-icon>
         </button>
      </td>
    `;
    fragment.appendChild(tr);
  });
  
  tbody.appendChild(fragment);

  // Restaurar scroll
  if (scrollContainer) scrollContainer.scrollTop = prevScrollTop;

  // Drag & Drop
  if (typeof enableGenericDragAndDrop === 'function' && AdminState.recursos.length > 0) {
    enableGenericDragAndDrop('tablaRecursosBody', (oldIndex, newIndex) => {
      // âœ… Usar arrayMove como en Tramos y Cursos
      if (typeof arrayMove === 'function') {
        arrayMove(AdminState.recursos, oldIndex, newIndex);
      } else {
        const item = AdminState.recursos.splice(oldIndex, 1)[0];
        AdminState.recursos.splice(newIndex, 0, item);
      }
      renderTablaRecursos();
      checkRecursosChanges();
    });
  }

  checkRecursosChanges();
}

// --- 4. ACCIONES (LÃ³gica Blindada) ---

// A. Mostrar/Ocultar Dropdown (Z-Index Fix)
function toggleDropdownRecurso(index, tipo, event) {
  if (event) { event.stopPropagation(); event.preventDefault(); }

  const dropdown = document.getElementById(`dropdown-${tipo}-${index}`);
  const container = document.getElementById(`container-${tipo}-${index}`);
  
  const estabaAbierto = dropdown && !dropdown.classList.contains('hidden');

  // Cerrar todos
  document.querySelectorAll('[id^="dropdown-"]').forEach(d => d.classList.add('hidden'));
  document.querySelectorAll('[id^="container-"]').forEach(c => c.classList.remove('z-50'));

  if (!estabaAbierto && dropdown && container) {
    dropdown.classList.remove('hidden');
    container.classList.add('z-50'); // Elevar sobre lo demÃ¡s
    
    // Auto-cierre
    const closeListener = () => {
        dropdown.classList.add('hidden');
        container.classList.remove('z-50');
        document.removeEventListener('click', closeListener);
    };
    setTimeout(() => document.addEventListener('click', closeListener), 0);
  }
}

// B. ACTUALIZACIÃ“N QUIRÃšRGICA (AquÃ­ estÃ¡ la magia ðŸª„)
// En lugar de renderizar toda la tabla, tocamos solo los elementos DOM necesarios
function actualizarDropdownRecurso(index, campo, valor) {
  // 1. Actualizar Dato en Memoria
  AdminState.recursos[index][campo] = valor;

  // 2. Actualizar Visualmente solo lo que cambiÃ³
  if (campo === 'tipo') {
      const info = TIPO_OPTIONS[valor];
      const bgEl = document.getElementById(`preview-tipo-bg-${index}`);
      const iconEl = document.getElementById(`preview-tipo-icon-${index}`);
      const textEl = document.getElementById(`preview-tipo-text-${index}`);

      if (bgEl && iconEl && textEl) {
          // Limpiar clases antiguas
          bgEl.className = `p-1 rounded ${info.bg} ${info.color}`;
          iconEl.setAttribute('icon', info.icon);
          textEl.innerText = info.label;
      }
  } 
  else if (campo === 'estado') {
      const info = ESTADO_OPTIONS[valor];
      const btnEl = document.getElementById(`btn-estado-main-${index}`);
      const textEl = document.getElementById(`preview-estado-text-${index}`);

      if (btnEl && textEl) {
          // Reemplazar clases base
          btnEl.className = `w-full text-xs font-bold px-3 py-1.5 rounded-full border shadow-sm transition-all flex items-center justify-center gap-1 whitespace-nowrap ${info.bg} ${info.color} ${info.border} hover:opacity-90 active:scale-95`;
          textEl.innerText = info.label;
      }
  }

  // 3. Cerrar Dropdown
  const dropdown = document.getElementById(`dropdown-${campo}-${index}`);
  const container = document.getElementById(`container-${campo}-${index}`);
  if (dropdown) dropdown.classList.add('hidden');
  if (container) container.classList.remove('z-50');

  // 4. Verificar Cambios
  checkRecursosChanges();
}

// C. EdiciÃ³n de Inputs (Texto y NÃºmeros)
function editarRecursoInput(inputEl, index, campo) {
  let valor = inputEl.value;
  
  // Forzar tipo numÃ©rico si es capacidad
  if (campo === 'capacidad') {
      valor = parseInt(valor, 10);
      if (isNaN(valor)) valor = 1; // Fallback
  }
  
  AdminState.recursos[index][campo] = valor;
  
  // Legacy support
  if(campo === 'nombre') AdminState.recursos[index].nombre_recurso = valor;

  // ValidaciÃ³n visual simple
  if (campo === 'nombre') {
      if (!valor) inputEl.classList.add('border-red-300', 'bg-red-50', 'placeholder-red-400');
      else inputEl.classList.remove('border-red-300', 'bg-red-50', 'placeholder-red-400');
  }

  checkRecursosChanges();
}

function agregarNuevoRecurso() {
  const nuevoId = generateId();
  
  AdminState.recursos.push({
    id_recurso: nuevoId,
    nombre: '',
    tipo: 'Dispositivo',
    icono: 'mdi:cube-outline',
    ubicacion: '',
    capacidad: 1,
    estado: 'Activo',
  });
  
  renderTablaRecursos(); // AquÃ­ sÃ­ render completo (hay nueva fila)
  
  setTimeout(() => { 
    const tbody = document.getElementById('tablaRecursosBody'); 
    if(tbody) tbody.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'center' }); 
  }, 100);
}

function eliminarRecursoFila(index) {
  mostrarConfirmacion('Â¿Eliminar Recurso?', 'Recuerda guardar cambios para confirmar.', () => {
      AdminState.recursos.splice(index, 1);
      renderTablaRecursos();
      checkRecursosChanges();
  });
}

// --- 5. GESTIÃ“N DE CAMBIOS (COMPARACIÃ“N PROFUNDA) ---

function checkRecursosChanges() {
  if (!AdminState.recursosOriginales) return;
  
  // Limpiamos los datos antes de comparar para evitar falsos positivos
  // (A veces se cuelan propiedades extraÃ±as en los objetos durante la ejecuciÃ³n)
  const limpiar = (arr) => arr.map(r => ({
      id: r.id_recurso,
      nom: r.nombre,
      tip: r.tipo,
      cap: parseInt(r.capacidad), // Aseguramos comparaciÃ³n numÃ©rica
      est: r.estado,
      ubi: r.ubicacion || '',
      ico: r.icono || 'mdi:cube-outline'

  }));

  const actualStr = JSON.stringify(limpiar(AdminState.recursos));
  const originalStr = JSON.stringify(limpiar(AdminState.recursosOriginales));
  
  AdminState.cambiosPendientes = (actualStr !== originalStr);
  
  if (AdminState.cambiosPendientes) {
    SaveBarManager.show("Recursos modificados", guardarCambiosRecursos, descartarCambiosRecursos);
  } else {
    SaveBarManager.hide();
  }
}

function guardarCambiosRecursos() {
  const invalidos = AdminState.recursos.filter(r => !r.nombre || r.nombre.trim() === '');
  if (invalidos.length > 0) {
      showToast('warning', `Falta el nombre en ${invalidos.length} recurso(s).`);
      return;
  }

  showLoading();
  google.script.run
    .withSuccessHandler(res => {
      hideLoading();
      if (res.success) {
        showToast('success', 'Recursos guardados');
        AdminState.recursosOriginales = JSON.parse(JSON.stringify(AdminState.recursos));
        AdminState.cambiosPendientes = false;
        SaveBarManager.hide();
        renderTablaRecursos();

        // âœ… SINCRONIZAR con globalState (para la vista de usuario)
        if (typeof globalState !== 'undefined') {
          globalState.recursos = JSON.parse(JSON.stringify(AdminState.recursos));
        }

        adminHaCambiadoDatos = true;
        if (typeof window.recargarDatosApp === 'function') {
          window.recargarDatosApp();
        }
      } else {
        showToast('error', res.error);
      }
    })
    .withFailureHandler(err => { hideLoading(); showToast('error', err); })
    .saveBatchRecursos(AdminState.recursos);
}

function descartarCambiosRecursos() {
  mostrarConfirmacion('Â¿Descartar cambios?', 'VolverÃ¡s al estado original.', () => {
      AdminState.recursos = JSON.parse(JSON.stringify(AdminState.recursosOriginales));
      AdminState.cambiosPendientes = false;
      renderTablaRecursos();
      SaveBarManager.hide();
      showToast('info', 'Cambios descartados');
  });
}

// EXPORTS
window.inicializarRecursos = inicializarRecursos;
window.renderTablaRecursos = renderTablaRecursos;
window.toggleDropdownRecurso = toggleDropdownRecurso;
window.actualizarDropdownRecurso = actualizarDropdownRecurso; // Nueva funciÃ³n
window.editarRecursoInput = editarRecursoInput; // Renombrada para claridad
window.agregarNuevoRecurso = agregarNuevoRecurso;
window.eliminarRecursoFila = eliminarRecursoFila;
window.guardarCambiosRecursos = guardarCambiosRecursos;
window.descartarCambiosRecursos = descartarCambiosRecursos;


/* =========================================================
   6.3. GESTIÃ“N DE DISPONIBILIDAD (VERSIÃ“N FINAL BLINDADA ðŸ›¡ï¸)
   ========================================================= */

const DIAS = ['Lunes', 'Martes', 'MiÃ©rcoles', 'Jueves', 'Viernes'];

let DispState = {
  recursoId: null,
  datosOriginales: [], 
  datosActuales: [],   
  cambiosPendientes: false,
  tramosCache: null
};

// 1. SELECTOR DE RECURSOS
function renderSelectRecursos() {
  const container = document.getElementById('dropdownRecursoDisp');
  if(!container) return;
  
  container.innerHTML = '';
  
  const lista = [...AdminState.recursos].sort((a, b) => {
      return (parseInt(a.orden) || 9999) - (parseInt(b.orden) || 9999);
  });
  
  if (lista.length === 0) {
    container.innerHTML = '<div class="p-4 text-center text-xs text-gray-400 italic">No hay recursos disponibles.</div>';
    return;
  }

  const fragment = document.createDocumentFragment();

  lista.forEach(r => {
    let icon = 'mdi:door-open'; 
    let color = 'text-indigo-600 bg-indigo-50';
    
    if(r.tipo === 'Dispositivo') { icon = 'mdi:laptop'; color = 'text-purple-600 bg-purple-50'; }
    if(r.tipo === 'Agrupado')    { icon = 'mdi:group';  color = 'text-orange-600 bg-orange-50'; }
    if(r.icono && r.icono.includes(':')) icon = r.icono; 

    const item = document.createElement('div');
    item.className = "flex items-center gap-3 px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-50 last:border-0 transition-all group";
    item.onclick = () => seleccionarRecursoDisp(r.id_recurso, r.nombre, icon, color);
    
    item.innerHTML = `
      <div class="p-2 rounded-lg ${color} flex items-center justify-center group-hover:scale-110 transition-transform">
         <iconify-icon icon="${icon}" class="text-lg"></iconify-icon>
      </div>
      <div class="flex flex-col">
         <span class="text-sm font-bold text-gray-700">${r.nombre}</span>
         <span class="text-[10px] text-gray-400 font-mono">${r.id_recurso}</span>
      </div>
    `;
    fragment.appendChild(item);
  });

  container.appendChild(fragment);
}

function toggleRecursoDropdown(e) {
  if(e) { e.stopPropagation(); e.preventDefault(); }
  const drop = document.getElementById('dropdownRecursoDisp');
  const estabaOculto = drop.classList.contains('hidden');
  
  document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.add('hidden'));

  if(estabaOculto) {
      drop.classList.remove('hidden');
      const closeFn = () => {
          drop.classList.add('hidden');
          document.removeEventListener('click', closeFn);
      };
      setTimeout(() => document.addEventListener('click', closeFn), 0);
  }
}

function seleccionarRecursoDisp(id, nombre, icon, colorClass) {
  const btn = document.getElementById('btnSelectorRecursoDisp');
  btn.innerHTML = `
      <div class="p-1.5 rounded-lg ${colorClass} flex items-center justify-center">
          <iconify-icon icon="${icon}" class="text-lg"></iconify-icon>
      </div>
      <span class="flex-1 text-sm font-bold text-gray-800 truncate text-left">${nombre}</span>
      <iconify-icon icon="mdi:chevron-down" class="text-gray-400"></iconify-icon>
  `;
  
  document.getElementById('dropdownRecursoDisp').classList.add('hidden');
  cargarMatrizDisponibilidad(id);
}


// 2. LÃ“GICA DE DATOS
function cargarMatrizDisponibilidad(idRecurso) {
  if (!idRecurso) return;
  
  DispState.recursoId = idRecurso;
  const idTarget = String(idRecurso).trim().toLowerCase();
  
  const datosRaw = AdminState.disponibilidad.filter(d => {
      const dId = String(d.id_recurso || '').trim().toLowerCase();
      return dId === idTarget;
  });

  const datosNormalizados = datosRaw.map(d => ({
    id_tramo: String(d.id_tramo).trim(),
    dia_semana: String(d.dia_semana).trim(),
    permitido: d.permitido || 'Si',
    razon_bloqueo: d.razon_bloqueo || ''
  }));

  DispState.datosOriginales = JSON.parse(JSON.stringify(datosNormalizados));
  DispState.datosActuales = JSON.parse(JSON.stringify(datosNormalizados));
  
  document.getElementById('emptyStateDisp').classList.add('hidden');
  document.getElementById('contenedorMatriz').classList.remove('hidden');
  document.getElementById('leyendaDisp').classList.remove('hidden');
  
  renderMatrizHTML();
  checkDispChanges(); 
}


// 3. RENDERIZADO DE LA MATRIZ (CON SCROLL PRESERVATION ðŸ›¡ï¸)
function renderMatrizHTML() {
  const tbody = document.getElementById('cuerpoMatriz');
  if (!tbody) return;
  
  // âœ… Scroll Preservation
  const scrollContainer = tbody.closest('.overflow-auto') || tbody.parentElement;
  const scrollPos = scrollContainer ? scrollContainer.scrollTop : 0;
  
  tbody.innerHTML = '';
  
  if (!DispState.tramosCache) {
      DispState.tramosCache = [...AdminState.tramos].sort((a,b) => (a.hora_inicio||'').localeCompare(b.hora_inicio||''));
  }
  const tramos = DispState.tramosCache;

  const mapaDatos = new Map();
  DispState.datosActuales.forEach(d => {
      mapaDatos.set(`${d.id_tramo}-${d.dia_semana}`, d);
  });

  const fragment = document.createDocumentFragment();

  tramos.forEach((tramo, index) => {
    const tr = document.createElement('tr');
    tr.className = "hover:bg-gray-50/50 transition-colors";
    
    tr.innerHTML = `
      <td class="px-4 py-3 border-r border-gray-200 bg-gray-50 sticky left-0 z-20 w-32 min-w-[120px] shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]">
        <div class="text-xs font-bold text-gray-700">${tramo.Nombre_Tramo || tramo.nombre}</div>
        <div class="text-[10px] text-gray-400 font-mono mt-0.5 flex items-center gap-1">
            <iconify-icon icon="mdi:clock-time-four-outline"></iconify-icon>
            ${tramo.hora_inicio} - ${tramo.hora_fin}
        </div>
      </td>
    `;

    const esPrimeraFila = (index === 0);

    DIAS.forEach(dia => {
      const dato = mapaDatos.get(`${tramo.id_tramo}-${dia}`);
      const td = document.createElement('td');
      td.id = `td-${tramo.id_tramo}-${dia}`; // ID Ãšnico
      
      const configVisual = getConfigVisualCelda(dato, tramo.id_tramo, dia, esPrimeraFila);
      td.className = configVisual.className;
      td.innerHTML = configVisual.innerHTML;
      
      td.onclick = (e) => {
        if(e.target.closest('.btn-info')) return; 
        toggleCelda(tramo.id_tramo, dia, esPrimeraFila);
      };

      tr.appendChild(td);
    });
    fragment.appendChild(tr);
  });
  
  tbody.appendChild(fragment);
  
  // âœ… Restaurar Scroll
  if (scrollContainer) {
    requestAnimationFrame(() => {
      scrollContainer.scrollTop = scrollPos;
    });
  }
}

// âœ… HELPER VISUAL
function getConfigVisualCelda(dato, idTramo, dia, esPrimeraFila) {
    const esBloqueado = dato && dato.permitido === 'No';
    const razon = dato ? (dato.razon_bloqueo || '') : '';
    
    const bgClass = esBloqueado ? "bg-red-50 hover:bg-red-100" : "bg-white hover:bg-green-50";
    const className = `p-1 border border-gray-100 h-14 text-center transition-all duration-200 relative group min-w-[110px] ${bgClass}`;

    const tooltipPos = esPrimeraFila ? 'top-full mt-2' : 'bottom-full mb-2';
    const arrowBorder = esPrimeraFila ? 'border-l-transparent border-r-transparent border-b-gray-800' : 'border-l-transparent border-r-transparent border-t-gray-800';
    const arrowPosClass = esPrimeraFila ? 'bottom-full' : 'top-full';

    const tooltipHTML = razon ? `
        <div class="absolute ${tooltipPos} left-1/2 -translate-x-1/2 px-3 py-2 bg-gray-800 text-white text-[11px] font-medium rounded-lg shadow-xl opacity-0 group-hover/btn:opacity-100 transition-all duration-200 pointer-events-none whitespace-normal w-48 text-center z-[100]">
            ${razon}
            <div class="absolute left-1/2 -translate-x-1/2 border-4 ${arrowBorder} ${arrowPosClass}"></div>
        </div>
    ` : '';

    let innerHTML = '';
    if (esBloqueado) {
        innerHTML = `
          <div class="relative w-full h-full flex flex-col items-center justify-center gap-1">
             <div class="flex items-center gap-1">
                 <iconify-icon icon="mdi:lock" class="text-red-500 text-lg animate-pulse-subtle"></iconify-icon>
                 <span class="text-[10px] font-bold text-red-600 uppercase">Bloq.</span>
             </div>
             <div class="absolute top-1 right-1 group/btn"> 
                 ${tooltipHTML}
                 <button onclick="editarNota('${idTramo}', '${dia}')" 
                         title="Editar motivo"
                         class="btn-info w-6 h-6 rounded-full bg-white hover:bg-blue-50 text-red-400 hover:text-blue-600 border border-red-100 hover:border-blue-200 shadow-sm flex items-center justify-center transition-all transform hover:scale-110">
                    <iconify-icon icon="${razon ? 'mdi:message-text' : 'mdi:pencil-outline'}" class="text-xs"></iconify-icon>
                 </button>
             </div>
          </div>
        `;
    } else {
        innerHTML = `
          <div class="w-full h-full flex items-center justify-center opacity-0 group-hover:opacity-40 transition-opacity">
             <iconify-icon icon="mdi:check-circle" class="text-green-500 text-2xl"></iconify-icon>
          </div>
        `;
    }

    return { className, innerHTML };
}


// 4. INTERACCIÃ“N (ACTUALIZACIÃ“N QUIRÃšRGICA ðŸ’‰)
function toggleCelda(idTramo, dia, esPrimeraFila = false) {
  idTramo = String(idTramo);
  
  let index = DispState.datosActuales.findIndex(d => 
    d.id_tramo === idTramo && d.dia_semana === dia
  );
  
  let datoActualizado = null;

  if (index === -1) {
    // Si no existe, creamos bloqueo
    datoActualizado = { id_tramo: idTramo, dia_semana: dia, permitido: 'No', razon_bloqueo: '' };
    DispState.datosActuales.push(datoActualizado);
  } else {
    // Si existe, lo modificamos (PERO NO LO BORRAMOS)
    const actual = DispState.datosActuales[index];
    
    if (actual.permitido === 'No') {
        // Desbloquear
        actual.permitido = 'Si';
        datoActualizado = actual; // Mantenemos el objeto para enviarlo al backend
    } else {
        // Bloquear
        actual.permitido = 'No';
        datoActualizado = actual;
    }
  }
  
  actualizarCeldaVisualmente(idTramo, dia, datoActualizado, esPrimeraFila);
  checkDispChanges();
}

function actualizarCeldaVisualmente(idTramo, dia, dato, esPrimeraFila) {
    const tdId = `td-${idTramo}-${dia}`;
    const td = document.getElementById(tdId);
    
    if (!td) {
        console.warn(`Celda ${tdId} no encontrada, forzando repintado completo.`);
        renderMatrizHTML();
        return;
    }
    
    if (esPrimeraFila === undefined) {
        const tr = td.parentElement;
        const tbody = tr.parentElement;
        esPrimeraFila = (Array.from(tbody.children).indexOf(tr) === 0);
    }

    const config = getConfigVisualCelda(dato, idTramo, dia, esPrimeraFila);
    td.className = config.className;
    td.innerHTML = config.innerHTML;
}


// 5. GESTIÃ“N DE CAMBIOS Y GUARDADO
const getDispKey = (arr) => arr.map(d => `${d.id_tramo}|${d.dia_semana}|${d.permitido}|${d.razon_bloqueo}`).sort();

function checkDispChanges() {
  const normalize = (list) => {
    return list
      .filter(d => {
          const tieneNota = d.razon_bloqueo && d.razon_bloqueo.trim().length > 0;
          return d.permitido === 'No' || tieneNota;
      })
      .map(d => `${d.id_tramo}|${d.dia_semana}|${d.permitido}|${(d.razon_bloqueo || '').trim()}`)
      .sort();
  };

  const originalStr = JSON.stringify(normalize(DispState.datosOriginales));
  const actualStr = JSON.stringify(normalize(DispState.datosActuales));
  
  const hayCambios = (originalStr !== actualStr);
  DispState.cambiosPendientes = hayCambios;
  
  if (hayCambios) {
    SaveBarManager.show("Horarios modificados", guardarCambiosDisp, descartarCambiosDisp);
  } else {
    SaveBarManager.hide();
  }
}

function guardarCambiosDisp() {
  if (!DispState.recursoId) {
      showToast('error', 'Error: No hay recurso seleccionado');
      return;
  }

  showLoading();
  
  const payload = DispState.datosActuales.map(d => ({
    id_recurso: DispState.recursoId,
    id_tramo: d.id_tramo,
    dia_semana: d.dia_semana,
    permitido: d.permitido,
    razon_bloqueo: d.razon_bloqueo
  }));
  
  google.script.run
    .withSuccessHandler(res => {
      hideLoading();
      if(res.success) {
        showToast('success', 'Disponibilidad guardada');
        DispState.datosOriginales = JSON.parse(JSON.stringify(DispState.datosActuales));
        AdminState.disponibilidad = AdminState.disponibilidad.filter(d => String(d.id_recurso) !== String(DispState.recursoId));
        payload.forEach(p => AdminState.disponibilidad.push(p));
        checkDispChanges();
      } else {
        showToast('error', res.error);
      }
    })
    .withFailureHandler(err => { hideLoading(); showToast('error', err); })
    .saveBatchDisponibilidad(payload);
}

function descartarCambiosDisp() {
  mostrarConfirmacion('Â¿Descartar cambios?', 'VolverÃ¡s a la configuraciÃ³n guardada.', () => {
      DispState.datosActuales = JSON.parse(JSON.stringify(DispState.datosOriginales));
      renderMatrizHTML();
      checkDispChanges();
      showToast('info', 'Cambios revertidos');
  });
}

// 6. GESTIÃ“N DEL MODAL

function ensureModalExists() {
    // Limpieza de modal antiguo
    const oldModal = document.getElementById('modalEditarNota');
    if (oldModal) {
        oldModal.remove();
        console.log("[Modal] Limpieza de versiÃ³n anterior");
    }

    // Prevenir duplicados
    if (window.isCreatingModal) return;
    window.isCreatingModal = true;

    const modalHTML = `
    <div id="modalEditarNota" class="fixed inset-0 z-[9999] hidden" role="dialog" aria-modal="true">
        <!-- Overlay con onclick directo -->
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity" 
             onclick="window.cerrarModalEditarNota()"></div>
        
        <!-- Container centrado -->
        <div class="fixed inset-0 z-10 flex min-h-full items-center justify-center p-4">
            
            <!-- Panel (con stopPropagation para que clicks internos no cierren) -->
            <div onclick="event.stopPropagation()" 
                 class="relative transform overflow-hidden rounded-xl bg-white text-left shadow-2xl transition-all w-full max-w-lg scale-95 opacity-0 duration-200" 
                 id="modalPanelNota">
                
                <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start gap-4">
                        <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-blue-50 sm:mx-0 sm:h-10 sm:w-10">
                            <iconify-icon icon="mdi:message-draw" class="text-blue-600 text-xl"></iconify-icon>
                        </div>
                        <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                            <h3 class="text-base font-semibold leading-6 text-gray-900">Motivo del bloqueo</h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 mb-3">RazÃ³n del bloqueo (ej: Mantenimiento, Limpieza).</p>
                                <textarea id="notaTextarea" rows="3" 
                                    class="w-full rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6 p-3"
                                    placeholder="Escribe aquÃ­..."></textarea>
                                <input type="hidden" id="notaTramoId">
                                <input type="hidden" id="notaDia">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-2">
                    <button type="button" 
                            onclick="window.guardarNotaModal()" 
                            class="inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:ml-3 sm:w-auto transition-colors">
                        Guardar Nota
                    </button>
                    <button type="button" 
                            onclick="window.cerrarModalEditarNota()" 
                            class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto transition-colors">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    window.isCreatingModal = false;
    console.log("[Modal] Creado correctamente");
}

function editarNota(idTramo, dia) {
  console.log(`[Modal] Abriendo para ${idTramo}-${dia}`);
  ensureModalExists();
  
  const dato = DispState.datosActuales.find(d => 
    String(d.id_tramo).trim() === String(idTramo).trim() && 
    d.dia_semana === dia
  );
  
  const txt = document.getElementById('notaTextarea');
  const inpId = document.getElementById('notaTramoId');
  const inpDia = document.getElementById('notaDia');

  if (txt) txt.value = dato ? (dato.razon_bloqueo || '') : '';
  if (inpId) inpId.value = idTramo;
  if (inpDia) inpDia.value = dia;
  
  const modal = document.getElementById('modalEditarNota');
  const panel = document.getElementById('modalPanelNota');
  
  if (modal && panel) {
      modal.classList.remove('hidden');
      requestAnimationFrame(() => {
          panel.classList.remove('scale-95', 'opacity-0');
          panel.classList.add('scale-100', 'opacity-100');
          // Foco al textarea despuÃ©s de la animaciÃ³n
          setTimeout(() => txt && txt.focus(), 50);
      });
  } else {
      console.error("[Modal] No se encontraron elementos del modal");
  }
}

function cerrarModalEditarNota() {
  console.log("[Modal] Cerrando...");
  const modal = document.getElementById('modalEditarNota');
  const panel = document.getElementById('modalPanelNota');
  
  if (!modal || !panel) {
      console.warn("[Modal] Elementos no encontrados para cerrar");
      return;
  }

  // Animar salida
  panel.classList.remove('scale-100', 'opacity-100');
  panel.classList.add('scale-95', 'opacity-0');
  
  // Ocultar despuÃ©s de animaciÃ³n
  setTimeout(() => {
      modal.classList.add('hidden');
      console.log("[Modal] Cerrado correctamente");
  }, 200);
}

function guardarNotaModal() {
  console.log("[Modal] Guardando nota...");
  const txt = document.getElementById('notaTextarea');
  if (!txt) {
    console.error("[Modal] Textarea no encontrado");
    return;
  }

  const texto = txt.value.trim();
  const idTramo = document.getElementById('notaTramoId')?.value;
  const dia = document.getElementById('notaDia')?.value;
  
  if (!idTramo || !dia) {
    console.error("[Modal] Datos de tramo/dÃ­a no encontrados");
    return;
  }
  
  let dato = DispState.datosActuales.find(d => 
    String(d.id_tramo).trim() === String(idTramo).trim() && 
    d.dia_semana === dia
  );

  if (dato) {
      dato.razon_bloqueo = texto;
      console.log("[Modal] Nota actualizada en dato existente");
  } else if (texto) {
      dato = { 
        id_tramo: idTramo, 
        dia_semana: dia, 
        permitido: 'No', 
        razon_bloqueo: texto 
      };
      DispState.datosActuales.push(dato);
      console.log("[Modal] Nueva nota creada");
  }
  
  cerrarModalEditarNota();
  actualizarCeldaVisualmente(idTramo, dia, dato);
  checkDispChanges();
}

// =========================================================
// EXPORTS (Asegurar acceso global)
// =========================================================
window.renderSelectRecursos = renderSelectRecursos;
window.toggleRecursoDropdown = toggleRecursoDropdown;
window.seleccionarRecursoDisp = seleccionarRecursoDisp;
window.editarNota = editarNota;
window.guardarNotaModal = guardarNotaModal;
window.cerrarModalEditarNota = cerrarModalEditarNota;
window.guardarCambiosDisp = guardarCambiosDisp;
window.descartarCambiosDisp = descartarCambiosDisp;


/* ==========================================
   6.4. GESTIÃ“N DE USUARIOS (Surgical Update âš¡)
   ========================================== */

// HELPER: ValidaciÃ³n y Seguridad
const esEmailValido = (email) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

// 0. InicializaciÃ³n
function inicializarUsuarios() {
  if (!AdminState.usuarios) return;
  
  // Normalizar
  AdminState.usuarios = AdminState.usuarios.map(u => ({
      ...u,
      Nombre: u.Nombre || u.Nombre_Completo || '',
      Email: u.Email || u.Email_Usuario || '',
      Admin: (u.Admin === true || u.Admin === "TRUE" || u.Admin === "Si"),
      Activo: (u.Activo === true || u.Activo === "TRUE" || u.Activo === "Si")
  }));

  AdminState.usuariosOriginales = JSON.parse(JSON.stringify(AdminState.usuarios));
  renderTablaUsuarios();
}

// 1. Renderizar Tabla (Con 'data-usuario-index')
function renderTablaUsuarios() {
  const tbody = document.getElementById('tablaUsuariosBody');
  if (!tbody) return;
  
  // Guardar scroll
  const scrollPos = tbody.parentElement ? tbody.parentElement.scrollTop : 0;

  // Asegurar table-fixed por si acaso
  const tabla = tbody.closest('table');
  if (tabla && !tabla.classList.contains('table-fixed')) {
      tabla.classList.add('table-fixed');
  }

  tbody.innerHTML = '';
  const filtro = (document.getElementById('buscadorUsuarios')?.value || '').toLowerCase();
  
  const lista = AdminState.usuarios.filter(u => {
    const nombre = u.Nombre.toLowerCase();
    const email = u.Email.toLowerCase();
    return nombre.includes(filtro) || email.includes(filtro);
  });

  const countSpan = document.getElementById('totalUsuariosCount');
  if(countSpan) {
      const total = AdminState.usuarios.length;
      countSpan.innerText = lista.length === total ? total : `${lista.length} / ${total}`;
  }

  if (lista.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="text-center py-12 text-gray-400">No se encontraron usuarios</td></tr>`;
    return;
  }

  const fragment = document.createDocumentFragment();

  lista.forEach((usuario) => {
    const index = AdminState.usuarios.indexOf(usuario); // Ãndice REAL
    const rnd = Math.random().toString(36).substring(7);
    const inicial = usuario.Nombre.charAt(0).toUpperCase() || '?';

    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-50 transition-colors border-b border-gray-100 group';
    
    // âœ… CLAVE 1: AÃ±adimos el Ã­ndice como atributo para encontrarlo luego
    tr.setAttribute('data-usuario-index', index);

    tr.innerHTML = `
      <td class="pl-6 pr-2 py-4 whitespace-nowrap">
        <div class="h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold border border-blue-200 shadow-sm select-none">
          ${inicial}
        </div>
      </td>

      <td class="px-2 py-3">
        <div class="flex flex-col gap-1 w-full">
          <input type="text" 
                 value="${escaparHTML(usuario.Nombre)}" 
                 oninput="editarUsuario(${index}, 'Nombre', this.value)"
                 class="w-full bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none text-sm font-medium text-gray-900 px-1 transition-colors truncate"
                 autocomplete="off" name="user_name_${rnd}">
                 
          <input type="text" 
                 value="${escaparHTML(usuario.Email)}"
                 oninput="editarUsuario(${index}, 'Email', this.value)"
                 class="w-full bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none text-xs text-gray-500 px-1 transition-colors truncate ${!esEmailValido(usuario.Email) && usuario.Email ? 'text-red-500 font-bold' : ''}"
                 autocomplete="off" name="user_email_${rnd}">
        </div>
      </td>

      <td class="px-2 py-3 whitespace-nowrap text-center">
        <div class="flex flex-col items-center justify-center cursor-pointer group/toggle" onclick="toggleUsuarioPropiedad(${index}, 'Admin')">
            <div class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors ${usuario.Admin ? 'bg-purple-600' : 'bg-gray-200 group-hover/toggle:bg-gray-300'}">
                <span class="translate-x-1 inline-block h-3 w-3 transform rounded-full bg-white transition-transform ${usuario.Admin ? 'translate-x-5' : 'translate-x-1'}"></span>
            </div>
            <span class="text-[10px] text-gray-400 mt-1 select-none w-full text-center block h-3 leading-3">
                ${usuario.Admin ? 'Admin' : 'Usuario'}
            </span>
        </div>
      </td>

      <td class="px-2 py-3 whitespace-nowrap text-center">
        <div class="flex flex-col items-center justify-center cursor-pointer group/toggle" onclick="toggleUsuarioPropiedad(${index}, 'Activo')">
            <div class="relative inline-flex h-5 w-9 items-center rounded-full transition-colors ${usuario.Activo ? 'bg-green-500' : 'bg-gray-200 group-hover/toggle:bg-gray-300'}">
                <span class="translate-x-1 inline-block h-3 w-3 transform rounded-full bg-white transition-transform ${usuario.Activo ? 'translate-x-5' : 'translate-x-1'}"></span>
            </div>
             <span class="text-[10px] text-gray-400 mt-1 select-none w-full text-center block h-3 leading-3">
                ${usuario.Activo ? 'Activo' : 'Inactivo'}
             </span>
        </div>
      </td>
      
      <td class="px-4 py-3 whitespace-nowrap text-right">
         <button onclick="eliminarUsuario(${index})" 
                class="text-gray-300 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-colors opacity-100 sm:opacity-0 sm:group-hover:opacity-100">
          <iconify-icon icon="mdi:trash-can-outline" width="20"></iconify-icon>
        </button>
      </td>
    `;
    fragment.appendChild(tr);
  });
  
  tbody.appendChild(fragment);
  if(tbody.parentElement) tbody.parentElement.scrollTop = scrollPos;
  actualizarBotonGuardarUsuarios();
}

// 2. Toggle "QUIRÃšRGICO" (Sin repintar toda la tabla)
function toggleUsuarioPropiedad(index, propiedad) {
  // 1. Actualizar memoria (Modelo)
  AdminState.usuarios[index][propiedad] = !AdminState.usuarios[index][propiedad];
  const nuevoValor = AdminState.usuarios[index][propiedad];
  
  // 2. Buscar fila en DOM (Vista)
  const tbody = document.getElementById('tablaUsuariosBody');
  const fila = tbody.querySelector(`tr[data-usuario-index="${index}"]`);
  
  // Fallback de seguridad: Si no encontramos la fila (ej. filtro raro), repintamos todo
  if (!fila) {
    renderTablaUsuarios();
    checkUsuariosChanges();
    return;
  }
  
  // 3. Modificar SOLO el elemento afectado
  // Columna 2 = Admin (Ã­ndice 2 en children porque Avatar es 0 y Datos es 1)
  // Columna 3 = Activo (Ã­ndice 3 en children)
  const colIndex = propiedad === 'Admin' ? 2 : 3;
  const celda = fila.children[colIndex];
  
  if (celda) {
      const slider = celda.querySelector('.inline-flex');
      const circle = slider.querySelector('span');
      const label = celda.querySelector('.text-\\[10px\\]');
      
      // Aplicar clases segÃºn estado
      if (nuevoValor) {
        // ACTIVO (ON)
        slider.className = `relative inline-flex h-5 w-9 items-center rounded-full transition-colors ${propiedad === 'Admin' ? 'bg-purple-600' : 'bg-green-500'}`;
        circle.className = 'translate-x-1 inline-block h-3 w-3 transform rounded-full bg-white transition-transform translate-x-5';
        label.textContent = propiedad === 'Admin' ? 'Admin' : 'Activo';
      } else {
        // INACTIVO (OFF)
        slider.className = 'relative inline-flex h-5 w-9 items-center rounded-full transition-colors bg-gray-200 group-hover/toggle:bg-gray-300';
        circle.className = 'translate-x-1 inline-block h-3 w-3 transform rounded-full bg-white transition-transform translate-x-1';
        label.textContent = propiedad === 'Admin' ? 'Usuario' : 'Inactivo';
      }
  }
  
  // 4. Check cambios (SaveBar)
  checkUsuariosChanges();
}

// 3. EdiciÃ³n
function editarUsuario(index, campo, valor) {
  AdminState.usuarios[index][campo] = valor;
  checkUsuariosChanges();
}

// 4. Agregar
function agregarNuevoUsuario() {
  const buscador = document.getElementById('buscadorUsuarios');
  if(buscador) buscador.value = '';

  const nuevo = { Nombre: '', Email: '', Activo: true, Admin: false };
  AdminState.usuarios.push(nuevo);
  
  renderTablaUsuarios(); // AquÃ­ sÃ­ repintamos todo para aÃ±adir la fila
  checkUsuariosChanges();
  
  setTimeout(() => {
    const tbody = document.getElementById('tablaUsuariosBody');
    if(tbody && tbody.lastElementChild) {
      tbody.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'center' });
      const inputs = tbody.lastElementChild.querySelectorAll('input');
      if(inputs[0]) inputs[0].focus();
    }
  }, 50);
}

// 5. Eliminar
function eliminarUsuario(index) {
  const usuario = AdminState.usuarios[index];
  const nombreSeguro = escaparHTML(usuario.Nombre || usuario.Email || 'Usuario');

  mostrarConfirmacion(
    'Â¿Eliminar Usuario?', 
    `Se eliminarÃ¡ el acceso para: <b>${nombreSeguro}</b>`, 
    () => {
      AdminState.usuarios.splice(index, 1);
      renderTablaUsuarios(); // AquÃ­ repintamos porque borramos una fila entera
      checkUsuariosChanges();
    }
  );
}

// 6. Check changes
function checkUsuariosChanges() {
  const actual = JSON.stringify(AdminState.usuarios);
  const original = JSON.stringify(AdminState.usuariosOriginales);
  
  AdminState.cambiosPendientes = (actual !== original);
  actualizarBotonGuardarUsuarios();
}

function actualizarBotonGuardarUsuarios() {
  if (AdminState.cambiosPendientes) {
    const diff = Math.abs(AdminState.usuarios.length - AdminState.usuariosOriginales.length);
    SaveBarManager.show(
        diff > 0 ? `${diff} cambios en lista` : 'Permisos modificados', 
        guardarCambiosUsuarios, 
        descartarCambiosUsuarios
    );
  } else {
    SaveBarManager.hide();
  }
}

// 7. Guardar
function guardarCambiosUsuarios() {
  const errores = [];
  AdminState.usuarios.forEach((u, i) => {
      if (!u.Nombre || u.Nombre.trim().length < 2) errores.push(`Fila ${i+1}: Falta nombre`);
      if (!esEmailValido(u.Email)) errores.push(`Fila ${i+1}: Email invÃ¡lido`);
  });

  if (errores.length > 0) {
      showToast('warning', `Revisa los datos: ${errores.slice(0,3).join('. ')}`);
      return;
  }

  showLoading();
  
  const payload = AdminState.usuarios.map(u => ({
      Nombre: u.Nombre.trim(),
      Email: u.Email.trim().toLowerCase(),
      Admin: u.Admin,
      Activo: u.Activo
  }));

  google.script.run
    .withSuccessHandler(res => {
      hideLoading();
      if(res.success) {
        showToast('success', 'Usuarios actualizados');
        AdminState.usuariosOriginales = JSON.parse(JSON.stringify(AdminState.usuarios));
        checkUsuariosChanges();
      } else {
        showToast('error', res.error);
      }
    })
    .withFailureHandler(err => { hideLoading(); showToast('error', err); })
    .saveBatchUsuarios(payload);
}

// 8. Descartar
function descartarCambiosUsuarios() {
  mostrarConfirmacion('Â¿Descartar cambios?', 'Se perderÃ¡n las modificaciones.', () => {
      if (AdminState.usuariosOriginales) {
          AdminState.usuarios = JSON.parse(JSON.stringify(AdminState.usuariosOriginales));
      }
      renderTablaUsuarios();
      checkUsuariosChanges();
      showToast('info', 'Cambios descartados');
  });
}

// EXPORTS
window.inicializarUsuarios = inicializarUsuarios;
window.renderTablaUsuarios = renderTablaUsuarios;
window.editarUsuario = editarUsuario;
window.agregarNuevoUsuario = agregarNuevoUsuario;
window.eliminarUsuario = eliminarUsuario;
window.toggleUsuarioPropiedad = toggleUsuarioPropiedad;
window.guardarCambiosUsuarios = guardarCambiosUsuarios;
window.descartarCambiosUsuarios = descartarCambiosUsuarios;



/* ============================================
   6.5. GESTIÃ“N DE CURSOS (OPTIMIZADA V3 - FINAL ðŸš€)
   ============================================ */

const CursosState = {
  cursosOriginales: [],
  cursosEnMemoria: [],
  modoVisualizacion: 'botones',
  modoOriginal: 'botones',
  cambiosPendientes: false
};

// --- 1. INICIALIZACIÃ“N ---
function inicializarCursos() {
  if (!AdminState.cursos) return;
  
  // 1. Clonar datos
  CursosState.cursosEnMemoria = JSON.parse(JSON.stringify(AdminState.cursos));
  CursosState.cursosOriginales = JSON.parse(JSON.stringify(AdminState.cursos));
  
  // 2. Estado visual
  const modo = AdminState.modoVisualizacion || 'botones';
  CursosState.modoVisualizacion = modo;
  CursosState.modoOriginal = modo;
  
  // 3. Resetear UI
  CursosState.cambiosPendientes = false;
  actualizarToggleVisualizacion();
  renderTablaCursos();
  SaveBarManager.hide();
}

// --- 2. RENDERIZADO OPTIMIZADO ---
function renderTablaCursos(filtro = null) {
  const tbody = document.getElementById('tablaCursosBody');
  if (!tbody) return;
  
  // âœ… Preservar scroll
  const scrollPos = tbody.parentElement ? tbody.parentElement.scrollTop : 0;
  
  tbody.innerHTML = '';

  let lista = filtro || CursosState.cursosEnMemoria;

  if (lista.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-gray-400">No hay cursos</td></tr>`;
    return;
  }

  const fragment = document.createDocumentFragment();

  lista.forEach((curso, index) => {
    // Si hay filtro, buscamos el Ã­ndice real en el array original
    const realIndex = filtro ? CursosState.cursosEnMemoria.indexOf(curso) : index;
    
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-50 transition-colors group bg-white border-b border-gray-100 draggable-row';
    // Solo permitimos arrastrar si NO hay filtro activo
    tr.setAttribute('draggable', !filtro); 
    tr.dataset.index = realIndex;

    const dragClass = filtro 
      ? 'opacity-30 cursor-not-allowed' 
      : 'cursor-grab hover:text-blue-600 active:cursor-grabbing handle';

    // ValidaciÃ³n visual (Borde rojo si estÃ¡ vacÃ­o)
    const errorClass = (!curso.curso || !curso.curso.trim()) ? 'border-red-300 bg-red-50' : 'border-transparent hover:border-gray-300';
    
    // Usamos la funciÃ³n global escaparHTML
    const valEtapa = typeof escaparHTML === 'function' ? escaparHTML(curso.etapa || '') : (curso.etapa || '');
    const valCurso = typeof escaparHTML === 'function' ? escaparHTML(curso.curso || '') : (curso.curso || '');

    tr.innerHTML = `
      <td class="px-4 py-2 text-center w-16 min-w-[40px] text-gray-400 align-middle ${dragClass}">
         <iconify-icon icon="mdi:drag-horizontal-variant" width="24"></iconify-icon>
      </td>

      <td class="px-4 py-2 min-w-[150px]">
        <input type="text" value="${valEtapa}" placeholder="Ej: Primaria"
          class="w-full bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 outline-none py-1 transition-colors text-gray-600"
          oninput="editarCurso(${realIndex}, 'etapa', this.value)">
      </td>

      <td class="px-4 py-2 min-w-[150px]">
        <input type="text" value="${valCurso}" placeholder="Ej: 1Âº A"
          class="w-full bg-transparent border-b ${errorClass} focus:border-blue-500 outline-none py-1 transition-colors font-bold text-gray-800"
          oninput="editarCurso(${realIndex}, 'curso', this.value)">
      </td>

      <td class="px-4 py-2 text-right w-24 min-w-[80px]">
        <button onclick="eliminarCurso(${realIndex})" 
                class="text-gray-300 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-colors opacity-100 sm:opacity-0 sm:group-hover:opacity-100">
          <iconify-icon icon="mdi:trash-can-outline" width="20"></iconify-icon>
        </button>
      </td>
    `;
    fragment.appendChild(tr);
  });
  
  tbody.appendChild(fragment);
  
  // âœ… Restaurar scroll
  if(tbody.parentElement) tbody.parentElement.scrollTop = scrollPos;
  
  // âœ… Drag & Drop CORREGIDO:
  // Ya no usamos "window.cursosDragDropInit".
  // Llamamos siempre a la funciÃ³n, porque ella misma se encarga de limpiar listeners viejos.
  if (!filtro && typeof enableGenericDragAndDrop === 'function') {
    enableGenericDragAndDrop('tablaCursosBody', (oldIndex, newIndex) => {
      // Usamos arrayMove global si existe
      if (typeof arrayMove === 'function') {
         arrayMove(CursosState.cursosEnMemoria, oldIndex, newIndex);
      } else {
         // Fallback manual
         const item = CursosState.cursosEnMemoria.splice(oldIndex, 1)[0];
         CursosState.cursosEnMemoria.splice(newIndex, 0, item);
      }
      renderTablaCursos(); // Repintar para refrescar Ã­ndices
      checkCursosChanges();
    });
  }
  
  checkCursosChanges();
}

// --- 3. ACCIONES ---

function editarCurso(index, campo, valor) {
  CursosState.cursosEnMemoria[index][campo] = valor;
  checkCursosChanges();
  
  // ValidaciÃ³n visual inmediata
  if (campo === 'curso') {
     const input = document.activeElement;
     if (input && (!valor || !valor.trim())) {
         input.classList.add('border-red-300', 'bg-red-50');
         input.classList.remove('border-transparent');
     } else if (input) {
         input.classList.remove('border-red-300', 'bg-red-50');
         input.classList.add('border-transparent');
     }
  }
}

function agregarNuevoCurso() {
  const searchInput = document.getElementById('searchCursos');
  if(searchInput) { searchInput.value = ''; }
  
  CursosState.cursosEnMemoria.push({ etapa: '', curso: '' });
  
  renderTablaCursos(); // Sin filtro
  
  setTimeout(() => {
    const tbody = document.getElementById('tablaCursosBody');
    if(tbody && tbody.lastElementChild) {
       tbody.lastElementChild.scrollIntoView({ behavior: 'smooth' });
       const inputs = tbody.lastElementChild.querySelectorAll('input');
       if(inputs[1]) inputs[1].focus(); // Foco en nombre curso
    }
  }, 100);
}

function eliminarCurso(index) {
  const curso = CursosState.cursosEnMemoria[index];
  const nombre = curso.curso || 'este curso sin nombre';
  
  const nombreSeguro = typeof escaparHTML === 'function' ? escaparHTML(nombre) : nombre;
  
  mostrarConfirmacion(
    'Â¿Eliminar Curso?', 
    `Se eliminarÃ¡ &quot;<b>${nombreSeguro}</b>&quot;. Las reservas asociadas podrÃ­an quedar huÃ©rfanas.`, 
    () => {
      CursosState.cursosEnMemoria.splice(index, 1);
      renderTablaCursos();
      checkCursosChanges();
    }
  );
}

function filtrarCursos() {
  const term = document.getElementById('searchCursos').value.toLowerCase();
  const filtrados = CursosState.cursosEnMemoria.filter(c => 
    (c.etapa || '').toLowerCase().includes(term) || 
    (c.curso || '').toLowerCase().includes(term)
  );
  renderTablaCursos(term ? filtrados : null);
}

// --- 4. CONTROL DE CAMBIOS Y GUARDADO ---

function checkCursosChanges() {
  const estadoActual = JSON.stringify({
    datos: CursosState.cursosEnMemoria,
    modo: CursosState.modoVisualizacion
  });
  
  const estadoOriginal = JSON.stringify({
    datos: CursosState.cursosOriginales,
    modo: CursosState.modoOriginal
  });
  
  CursosState.cambiosPendientes = (estadoActual !== estadoOriginal);
  actualizarBotonGuardarCursos();
}

function actualizarBotonGuardarCursos() {
  if (CursosState.cambiosPendientes) {
    const diff = CursosState.cursosEnMemoria.length - CursosState.cursosOriginales.length;
    let texto = "Se han modificado los cursos";
    if (diff > 0) texto = `${diff} cursos aÃ±adidos`;
    if (diff < 0) texto = `${Math.abs(diff)} cursos eliminados`;

    SaveBarManager.show(texto, guardarCambiosCursos, descartarCambiosCursos);
  } else {
    SaveBarManager.hide();
  }
}

function guardarCambiosCursos() {
  // âœ… ValidaciÃ³n Previa (Bloqueante)
  const cursosVacios = CursosState.cursosEnMemoria.some(c => !c.curso || !c.curso.trim());
  if (cursosVacios) {
      showToast('warning', 'Hay cursos sin nombre. Por favor, revÃ­salos (marcados en rojo).');
      renderTablaCursos();
      return;
  }

  showLoading();
  
  const payload = {
    cursos: CursosState.cursosEnMemoria,
    modoVisualizacion: CursosState.modoVisualizacion
  };

  google.script.run
    .withSuccessHandler(res => {
  hideLoading();
  if (res.success) {
    showToast('success', 'Cursos actualizados correctamente');
    
    CursosState.cursosOriginales = JSON.parse(JSON.stringify(CursosState.cursosEnMemoria));
    CursosState.modoOriginal = CursosState.modoVisualizacion;
    
    if(AdminState) AdminState.modoVisualizacion = CursosState.modoVisualizacion;
    
    CursosState.cambiosPendientes = false; 
    SaveBarManager.hide();
    
    // âœ… MODIFICADO: Activar flag y recargar
    adminHaCambiadoDatos = true;
    if (typeof window.recargarDatosApp === 'function') {
      window.recargarDatosApp();
    }
  } else {
    showToast('error', res.error);
  }
})
    .withFailureHandler(err => { hideLoading(); showToast('error', err); })
    .saveAllCursos(payload);
}

function descartarCambiosCursos() {
  mostrarConfirmacion(
    'Â¿Descartar cambios?',
    'Se perderÃ¡n todas las modificaciones no guardadas.',
    () => {
      CursosState.cursosEnMemoria = JSON.parse(JSON.stringify(CursosState.cursosOriginales));
      CursosState.modoVisualizacion = CursosState.modoOriginal;
      
      CursosState.cambiosPendientes = false;
      actualizarToggleVisualizacion();
      renderTablaCursos(); // Reset total
      SaveBarManager.hide();
      
      showToast('info', 'Cambios descartados');
    }
  );
}

// --- 5. MODO VISUALIZACIÃ“N ---

function cambiarModoVisualizacionCursos(nuevoModo) {
  CursosState.modoVisualizacion = nuevoModo;
  actualizarToggleVisualizacion();
  checkCursosChanges(); 
}

function actualizarToggleVisualizacion() {
  const container = document.getElementById('modoVisualizacionToggle');
  if (!container) return;
  
  const btns = container.querySelectorAll('button');
  btns.forEach(btn => {
    const esActivo = btn.getAttribute('data-modo') === CursosState.modoVisualizacion;
    if (esActivo) {
      btn.className = 'px-3 py-1.5 rounded-md transition-all shadow-sm bg-white text-gray-800 font-medium border border-gray-200';
    } else {
      btn.className = 'px-3 py-1.5 rounded-md transition-all text-gray-500 hover:text-gray-700 hover:bg-gray-100';
    }
  });
}

// EXPORTS
window.inicializarCursos = inicializarCursos;
window.renderTablaCursos = renderTablaCursos;
window.editarCurso = editarCurso;
window.agregarNuevoCurso = agregarNuevoCurso;
window.eliminarCurso = eliminarCurso;
window.filtrarCursos = filtrarCursos;
window.cambiarModoVisualizacionCursos = cambiarModoVisualizacionCursos;
window.guardarCambiosCursos = guardarCambiosCursos;
window.descartarCambiosCursos = descartarCambiosCursos;


/* ============================================
   6.6. GESTIÃ“N DE TRAMOS (OPTIMIZADO V4 - FINAL ðŸ›¡ï¸)
   ============================================ */

// 1. INICIALIZACIÃ“N (CRÃTICO: Punto de entrada Ãºnico)

// FunciÃ³n auxiliar para normalizar formato HH:mm
function normalizarHora(hora) {
  if (!hora) return '';
  
  // Si ya viene como objeto Date, convertir
  if (hora instanceof Date) {
    const h = String(hora.getHours()).padStart(2, '0');
    const m = String(hora.getMinutes()).padStart(2, '0');
    return `${h}:${m}`;
  }
  
  // Si es string, asegurar formato HH:mm
  const partes = String(hora).split(':');
  if (partes.length >= 2) {
    const h = partes[0].padStart(2, '0');
    const m = partes[1].padStart(2, '0');
    return `${h}:${m}`;
  }
  
  return hora;
}

function inicializarTramos() {
  if (!AdminState.tramos) return;
  
  // Normalizar datos (asegurar que Nombre_Tramo, nombre Y HORAS estÃ©n correctas)
  AdminState.tramos = AdminState.tramos.map(t => ({
    ...t,
    Nombre_Tramo: t.Nombre_Tramo || t.nombre || '',
    nombre: t.nombre || t.Nombre_Tramo || '',
    hora_inicio: normalizarHora(t.hora_inicio),  
    hora_fin: normalizarHora(t.hora_fin)
  }));
  
  // Resto del cÃ³digo...
  AdminState.tramosOriginales = JSON.parse(JSON.stringify(AdminState.tramos));
  AdminState.cambiosPendientes = false;
  
  renderTablaTramos();
  SaveBarManager.hide();
}

// 2. RENDERIZADO
function renderTablaTramos() {
  const tbody = document.getElementById('tablaTramosBody');
  if (!tbody) return;
  
  // UX: Mantener posiciÃ³n del scroll
  const scrollPos = tbody.parentElement ? tbody.parentElement.scrollTop : 0;
  tbody.innerHTML = '';

  // ValidaciÃ³n de seguridad
  if (!AdminState.tramos || AdminState.tramos.length === 0) {
     tbody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-gray-400">No hay tramos definidos</td></tr>`;
     return;
  }

  const fragment = document.createDocumentFragment();

  AdminState.tramos.forEach((tramo, index) => {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-gray-50 transition-colors group bg-white border-b border-gray-100 draggable-row';
    tr.setAttribute('draggable', 'true');
    tr.dataset.index = index;

    // âœ… Usamos tu funciÃ³n global directamente
    const valId = escaparHTML(tramo.id_tramo);
    const valNombre = escaparHTML(tramo.Nombre_Tramo || tramo.nombre);
    const valInicio = normalizarHora(tramo.hora_inicio) || '';
    const valFin = normalizarHora(tramo.hora_fin) || '';

    // UX: Bordes rojos si falta info
    const errId = (!tramo.id_tramo || !tramo.id_tramo.trim()) ? 'border-red-300 bg-red-50' : 'border-transparent hover:border-gray-300';
    const errNombre = (!tramo.Nombre_Tramo || !tramo.Nombre_Tramo.trim()) ? 'border-red-300 bg-red-50' : 'border-transparent hover:border-gray-300';
    const errInicio = (!valInicio) ? 'border-red-300 bg-red-50' : 'border-gray-200';
    const errFin = (!valFin) ? 'border-red-300 bg-red-50' : 'border-gray-200';

    tr.innerHTML = `
      <td class="px-4 py-2 text-center w-16 min-w-[40px] cursor-grab text-gray-400 hover:text-blue-600 active:cursor-grabbing handle align-middle">
         <iconify-icon icon="mdi:drag-horizontal-variant" width="24"></iconify-icon>
      </td>

      <td class="px-4 py-2 w-24 min-w-[80px]">
        <input type="text" value="${valId}" placeholder="ID"
          class="w-full bg-transparent border-b ${errId} focus:border-blue-500 outline-none py-1 text-sm font-mono font-bold text-gray-700 text-center transition-colors"
          oninput="editarTramo(${index}, 'id_tramo', this.value)">
      </td>

      <td class="px-4 py-2 min-w-[150px]">
        <input type="text" value="${valNombre}" placeholder="Nombre del tramo"
          class="w-full bg-transparent border-b ${errNombre} focus:border-blue-500 outline-none py-1 font-bold text-gray-800 transition-colors"
          oninput="editarTramo(${index}, 'Nombre_Tramo', this.value)">
      </td>

      <td class="px-4 py-2 w-32 min-w-[110px]">
        <div class="relative">
            <input type="time" value="${valInicio}" 
              class="bg-white border ${errInicio} rounded-lg px-2 py-1 text-sm focus:border-blue-500 outline-none transition-colors w-full text-center"
              oninput="editarTramo(${index}, 'hora_inicio', this.value)">
        </div>
      </td>

      <td class="px-4 py-2 w-32 min-w-[110px]">
        <div class="relative">
            <input type="time" value="${valFin}" 
              class="bg-white border ${errFin} rounded-lg px-2 py-1 text-sm focus:border-blue-500 outline-none transition-colors w-full text-center"
              oninput="editarTramo(${index}, 'hora_fin', this.value)">
        </div>
      </td>

      <td class="px-4 py-2 text-right w-16 min-w-[60px]">
        <button onclick="eliminarTramo(${index})" class="text-gray-300 hover:text-red-600 p-2 rounded-full hover:bg-red-50 transition-colors opacity-100 sm:opacity-0 sm:group-hover:opacity-100">
           <iconify-icon icon="mdi:trash-can-outline" width="20"></iconify-icon>
        </button>
      </td>
    `;
    fragment.appendChild(tr);
  });
  
  tbody.appendChild(fragment);
  if(tbody.parentElement) tbody.parentElement.scrollTop = scrollPos; // Restaurar scroll

  // Drag & Drop Universal (Usa el DragDropManager global)
  if (typeof enableGenericDragAndDrop === 'function') {
    enableGenericDragAndDrop('tablaTramosBody', (oldIndex, newIndex) => {
      // Usamos tu funciÃ³n global arrayMove
      if (typeof arrayMove === 'function') {
        arrayMove(AdminState.tramos, oldIndex, newIndex);
      }
      renderTablaTramos();
      checkTramosChanges();
    });
  }
  
  checkTramosChanges();
}

// 3. EDICIÃ“N
function editarTramo(index, campo, valor) {
  const tramo = AdminState.tramos[index];
  if (!tramo) return;

  // Tracking de ID original
  if (campo === 'id_tramo') {
    if (!tramo._originalId) {
      tramo._originalId = tramo.id_tramo;
    }
  }

  tramo[campo] = valor;
  
  // SincronizaciÃ³n nombre
  if(campo === 'Nombre_Tramo') tramo.nombre = valor;
  
  checkTramosChanges();
  
  // ValidaciÃ³n visual "live"
  if (campo === 'id_tramo' || campo === 'Nombre_Tramo') {
      const el = document.activeElement;
      if(el && (!valor || !valor.trim())) {
          el.classList.add('border-red-300', 'bg-red-50');
          el.classList.remove('border-transparent');
      } else if (el) {
          el.classList.remove('border-red-300', 'bg-red-50');
          el.classList.add('border-transparent');
      }
  }
}

function agregarNuevoTramo() {
  if (!AdminState.tramos) AdminState.tramos = [];
  
  const num = AdminState.tramos.length + 1;
  const nuevoId = `T-${String(num).padStart(3, '0')}`;
  
  AdminState.tramos.push({
    id_tramo: nuevoId,
    Nombre_Tramo: '', 
    nombre: '',
    hora_inicio: '09:00',
    hora_fin: '10:00'
  });

  renderTablaTramos();
  
  setTimeout(() => {
     const tbody = document.getElementById('tablaTramosBody');
     if(tbody && tbody.lastElementChild) {
       tbody.lastElementChild.scrollIntoView({behavior:'smooth'});
       const inputs = tbody.lastElementChild.querySelectorAll('input');
       if(inputs[1]) inputs[1].focus(); // Foco en nombre
     }
  }, 100);
}

function eliminarTramo(index) {
  const tramo = AdminState.tramos[index];
  const nombre = tramo.Nombre_Tramo || tramo.nombre || 'este tramo';

  // âœ… Usamos escaparHTML global
  mostrarConfirmacion(
    'Â¿Eliminar Tramo?', 
    `Se eliminarÃ¡ &quot;<b>${escaparHTML(nombre)}</b>&quot;. DesaparecerÃ¡ de la configuraciÃ³n de horarios.`, 
    () => {
      AdminState.tramos.splice(index, 1);
      renderTablaTramos();
      checkTramosChanges();
    }
  );
}

// 4. CONTROL DE CAMBIOS
function checkTramosChanges() {
  if (!AdminState.tramosOriginales) return;

  // Limpiamos _originalId para comparar limpiamente
  const cleanCurrent = AdminState.tramos.map(t => {
      const { _originalId, ...rest } = t; 
      return rest;
  });
  const cleanOriginal = AdminState.tramosOriginales.map(t => {
      const { _originalId, ...rest } = t;
      return rest;
  });

  const currentStr = JSON.stringify(cleanCurrent);
  const originalStr = JSON.stringify(cleanOriginal);
  
  AdminState.cambiosPendientes = (currentStr !== originalStr);
  actualizarEstadoBotonGuardarTramos();
}

function actualizarEstadoBotonGuardarTramos() {
  if (AdminState.cambiosPendientes) {
    const diff = AdminState.tramos.length - (AdminState.tramosOriginales || []).length;
    let texto = "Horarios modificados";
    if (diff > 0) texto = `${diff} tramos aÃ±adidos`;
    if (diff < 0) texto = `${Math.abs(diff)} tramos eliminados`;

    SaveBarManager.show(texto, guardarCambiosTramos, descartarCambiosTramos);
  } else {
    SaveBarManager.hide();
  }
}

// 5. GUARDAR Y DESCARTAR
function guardarCambiosTramos() {
  // ValidaciÃ³n de campos obligatorios
  const tramosInvalidos = AdminState.tramos.some(t => 
    !t.id_tramo?.trim() || !t.Nombre_Tramo?.trim() || !t.hora_inicio || !t.hora_fin
  );

  if (tramosInvalidos) {
    showToast('warning', 'Hay tramos con datos incompletos (en rojo). RevÃ­salos.');
    renderTablaTramos(); 
    return;
  }

  showLoading();
  
  const datosAEnviar = AdminState.tramos.map(t => ({
      id_tramo: t.id_tramo,
      Nombre_Tramo: t.Nombre_Tramo || t.nombre,
      nombre: t.Nombre_Tramo || t.nombre,
      hora_inicio: t.hora_inicio,
      hora_fin: t.hora_fin,
      _originalId: t._originalId 
  }));

  google.script.run
    .withSuccessHandler(function(response) {
  hideLoading();
  if (response.success) {
    showToast('success', 'Tramos guardados correctamente');
    AdminState.tramosOriginales = JSON.parse(JSON.stringify(AdminState.tramos));
    AdminState.tramos.forEach(t => delete t._originalId);
    checkTramosChanges();
    
    // âœ… MODIFICADO: Activar flag y recargar
    adminHaCambiadoDatos = true;
    if (typeof window.recargarDatosApp === 'function') {
      window.recargarDatosApp();
    }
  } else {
    showToast('error', response.error);
  }
})
    .withFailureHandler(err => {
        hideLoading();
        showToast('error', err);
    })
    .saveBatchTramos(datosAEnviar);
}

function descartarCambiosTramos() {
  mostrarConfirmacion(
    'Â¿Descartar cambios?',
    'VolverÃ¡s a la configuraciÃ³n original de tramos.',
    () => {
      AdminState.tramos = JSON.parse(JSON.stringify(AdminState.tramosOriginales));
      renderTablaTramos();
      AdminState.cambiosPendientes = false;
      SaveBarManager.hide();
      showToast('info', 'Cambios en tramos descartados');
    }
  );
}

// EXPORTS
window.normalizarHora = normalizarHora;
window.inicializarTramos = inicializarTramos;
window.renderTablaTramos = renderTablaTramos;
window.editarTramo = editarTramo;
window.agregarNuevoTramo = agregarNuevoTramo;
window.eliminarTramo = eliminarTramo;
window.guardarCambiosTramos = guardarCambiosTramos;
window.descartarCambiosTramos = descartarCambiosTramos;


/* =========================================================
   6.7. GESTIÃ“N DE CONFIGURACIÃ“N (V5 - FIX DETECCIÃ“N âš™ï¸)
   ========================================================= */

const ConfigState = {
  configOriginal: null,
  cambiosPendientes: false
};

window.configListenersAttached = false;

// --- HELPERS ---
const setCfgVal = (id, value) => {
  const el = document.getElementById(id);
  if (el) el.value = (value === null || value === undefined) ? '' : String(value);
};

const getCfgVal = (id) => {
  const el = document.getElementById(id);
  return el ? el.value.trim() : '';
};

const setCfgCheck = (id, value) => {
  const el = document.getElementById(id);
  if (el) el.checked = (value === true || value === 'true' || value === 'Si' || value === 1);
};

const getCfgCheck = (id) => {
  const el = document.getElementById(id);
  return el ? el.checked : false;
};

// --- INICIALIZACIÃ“N (CORREGIDA) ---
function inicializarConfiguracion() {
  if (!AdminState.config) return;
  
  // 1. PRIMERO renderizar (normaliza valores)
  renderConfiguracion();
  
  // 2. LUEGO crear snapshot desde el DOM (valores ya normalizados)
  ConfigState.configOriginal = construirConfigDesdeInputs();
  ConfigState.cambiosPendientes = false;
  
  // 3. Activar listeners
  attachConfigListeners();
  
  SaveBarManager.hide();
}

// --- RENDERIZAR ---
function renderConfiguracion() {
  if (!AdminState.config) return;

  const configMap = {};
  AdminState.config.forEach(c => configMap[c.clave] = c.valor);

  // Renderizar TODOS los campos con defaults
  setCfgVal('cfg_dias_vista_maximo',   configMap['dias_vista_maximo'] || '30');
  setCfgVal('cfg_minutos_antelacion',  configMap['minutos_antelacion'] || '30');
  setCfgVal('cfg_limite_reservas',     configMap['limite_reservas'] || '5');
  setCfgVal('cfg_horas_cancelacion',   configMap['horas_cancelacion'] || '2');
  setCfgVal('cfg_email_admin',         configMap['email_admin'] || '');
  setCfgVal('cfg_nombre_centro',       configMap['nombre_centro'] || 'Sistema de Reservas');
  setCfgVal('cfg_url_logo',            configMap['url_logo'] || '');
  setCfgVal('cfg_max_tramos_simultaneos', configMap['max_tramos_simultaneos'] || '1');
  
  setCfgCheck('cfg_permitir_multitramo',  configMap['permitir_multitramo']);
  setCfgCheck('cfg_exigir_motivo',        configMap['exigir_motivo']);
  setCfgCheck('cfg_modo_mantenimiento',   configMap['modo_mantenimiento']);
}

// --- LISTENERS ---
function attachConfigListeners() {
  if (window.configListenersAttached) return;

  const ids = [
    'cfg_dias_vista_maximo', 'cfg_minutos_antelacion', 'cfg_limite_reservas',
    'cfg_horas_cancelacion', 'cfg_email_admin', 'cfg_nombre_centro',
    'cfg_url_logo', 'cfg_max_tramos_simultaneos', 'cfg_permitir_multitramo',
    'cfg_exigir_motivo', 'cfg_modo_mantenimiento'
  ];
  
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('input', checkConfigChanges);
      el.addEventListener('change', checkConfigChanges);
    }
  });

  window.configListenersAttached = true;
}

// --- DETECCIÃ“N DE CAMBIOS ---
function checkConfigChanges() {
  if (!ConfigState.configOriginal) return;
  
  const configActual = construirConfigDesdeInputs();
  
  // Comparar JSONs ordenados
  const sortFunc = (a,b) => a.clave.localeCompare(b.clave);
  const actualStr = JSON.stringify(configActual.sort(sortFunc));
  const originalStr = JSON.stringify([...ConfigState.configOriginal].sort(sortFunc));
  
  ConfigState.cambiosPendientes = (actualStr !== originalStr);
  
  if (ConfigState.cambiosPendientes) {
    SaveBarManager.show('ConfiguraciÃ³n modificada', guardarConfiguracion, descartarCambiosConfiguracion);
  } else {
    SaveBarManager.hide();
  }
}

function construirConfigDesdeInputs() {
  return [
    { clave: 'dias_vista_maximo',  valor: getCfgVal('cfg_dias_vista_maximo') },
    { clave: 'minutos_antelacion', valor: getCfgVal('cfg_minutos_antelacion') },
    { clave: 'limite_reservas',    valor: getCfgVal('cfg_limite_reservas') },
    { clave: 'horas_cancelacion',  valor: getCfgVal('cfg_horas_cancelacion') },
    { clave: 'email_admin',        valor: getCfgVal('cfg_email_admin') },
    { clave: 'nombre_centro',      valor: getCfgVal('cfg_nombre_centro') },
    { clave: 'url_logo',           valor: getCfgVal('cfg_url_logo') },
    { clave: 'max_tramos_simultaneos', valor: getCfgVal('cfg_max_tramos_simultaneos') },
    { clave: 'permitir_multitramo',    valor: getCfgCheck('cfg_permitir_multitramo') },
    { clave: 'exigir_motivo',      valor: getCfgCheck('cfg_exigir_motivo') },
    { clave: 'modo_mantenimiento', valor: getCfgCheck('cfg_modo_mantenimiento') }
  ];
}

// --- VALIDACIÃ“N ---
function validarConfiguracion() {
  const errores = [];
  
  const diasVista = parseInt(getCfgVal('cfg_dias_vista_maximo'));
  if (isNaN(diasVista) || diasVista < 1 || diasVista > 365) {
    errores.push('DÃ­as de vista: entre 1 y 365');
  }
  
  const minAnt = parseInt(getCfgVal('cfg_minutos_antelacion'));
  if (isNaN(minAnt) || minAnt < 0) {
    errores.push('Minutos antelaciÃ³n: debe ser positivo');
  }
  
  const limRes = parseInt(getCfgVal('cfg_limite_reservas'));
  if (isNaN(limRes) || limRes < 1 || limRes > 50) {
    errores.push('LÃ­mite reservas: entre 1 y 50');
  }
  
  const horasCanc = parseInt(getCfgVal('cfg_horas_cancelacion'));
  if (isNaN(horasCanc) || horasCanc < 0) {
    errores.push('Horas cancelaciÃ³n: debe ser positivo');
  }
  
  const maxTramos = parseInt(getCfgVal('cfg_max_tramos_simultaneos'));
  if (isNaN(maxTramos) || maxTramos < 1 || maxTramos > 10) {
    errores.push('Tramos simultÃ¡neos: entre 1 y 10');
  }
  
  const email = getCfgVal('cfg_email_admin');
  if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    errores.push('Email de administrador invÃ¡lido');
  }
  
  const urlLogo = getCfgVal('cfg_url_logo');
  if (urlLogo && !/^https?:\/\/.+/.test(urlLogo)) {
    errores.push('URL del logo debe empezar con http:// o https://');
  }
  // Validar que si es URL de Drive, tenga un formato reconocible
  if (urlLogo && urlLogo.includes('drive.google.com')) {
    const drivePatterns = [
      /\/file\/d\/([a-zA-Z0-9_-]+)/,
      /[?&]id=([a-zA-Z0-9_-]+)/,
      /\/d\/([a-zA-Z0-9_-]+)/
    ];
    const isValidDriveUrl = drivePatterns.some(p => p.test(urlLogo));
    if (!isValidDriveUrl) {
      errores.push('URL de Google Drive no reconocida. Usa el enlace "Compartir" del archivo.');
    }
  }
  
  return errores;
}

// --- GUARDAR ---
function guardarConfiguracion() {
  const errores = validarConfiguracion();
  if (errores.length > 0) {
    showToast('warning', `Revisa: ${errores.slice(0, 2).join('. ')}`);
    return;
  }

  showLoading();
  const newConfig = construirConfigDesdeInputs();

  // Verificar si hay URL de logo de Drive para procesar permisos
  const urlLogoConfig = newConfig.find(c => c.clave === 'url_logo');
  const urlLogo = urlLogoConfig ? urlLogoConfig.valor : '';
  const esDriveUrl = urlLogo && urlLogo.includes('drive.google.com');

  if (esDriveUrl) {
    // Primero procesar la URL de Drive para cambiar permisos
    google.script.run
      .withSuccessHandler(driveResult => {
        if (driveResult.warning) {
          showToast('warning', driveResult.message, 5000);
        } else if (driveResult.isDrive && driveResult.permissionsChanged) {
          showToast('info', 'Permisos de imagen actualizados automÃ¡ticamente');
        }
        // Continuar guardando la configuraciÃ³n
        finalizarGuardadoConfiguracion(newConfig);
      })
      .withFailureHandler(err => {
        // Aunque falle el procesamiento de Drive, intentar guardar la config
        console.warn('Error procesando URL de Drive:', err);
        finalizarGuardadoConfiguracion(newConfig);
      })
      .procesarUrlLogoDrive(urlLogo);
  } else {
    // No es URL de Drive, guardar directamente
    finalizarGuardadoConfiguracion(newConfig);
  }
}

function finalizarGuardadoConfiguracion(newConfig) {
  google.script.run
    .withSuccessHandler(res => {
      hideLoading();
      if(res.success) {
        showToast('success', 'ConfiguraciÃ³n guardada');

        AdminState.config = newConfig;
        ConfigState.configOriginal = JSON.parse(JSON.stringify(newConfig));
        ConfigState.cambiosPendientes = false;

        SaveBarManager.hide();
      } else {
        showToast('error', res.error);
      }
    })
    .withFailureHandler(err => {
      hideLoading();
      showToast('error', err);
    })
    .saveBatchConfig(newConfig);
}

// --- DESCARTAR ---
function descartarCambiosConfiguracion() {
  mostrarConfirmacion(
    'Â¿Descartar cambios?',
    'VolverÃ¡s a la configuraciÃ³n guardada.',
    () => {
      // Revertir a snapshot original
      const configMap = {};
      ConfigState.configOriginal.forEach(c => configMap[c.clave] = c.valor);
      
      // Re-renderizar con valores originales
      setCfgVal('cfg_dias_vista_maximo',   configMap['dias_vista_maximo']);
      setCfgVal('cfg_minutos_antelacion',  configMap['minutos_antelacion']);
      setCfgVal('cfg_limite_reservas',     configMap['limite_reservas']);
      setCfgVal('cfg_horas_cancelacion',   configMap['horas_cancelacion']);
      setCfgVal('cfg_email_admin',         configMap['email_admin']);
      setCfgVal('cfg_nombre_centro',       configMap['nombre_centro']);
      setCfgVal('cfg_url_logo',            configMap['url_logo']);
      setCfgVal('cfg_max_tramos_simultaneos', configMap['max_tramos_simultaneos']);
      
      setCfgCheck('cfg_permitir_multitramo',  configMap['permitir_multitramo']);
      setCfgCheck('cfg_exigir_motivo',        configMap['exigir_motivo']);
      setCfgCheck('cfg_modo_mantenimiento',   configMap['modo_mantenimiento']);
      
      ConfigState.cambiosPendientes = false;
      SaveBarManager.hide();
      showToast('info', 'Cambios descartados');
    }
  );
}

// EXPORTS
window.inicializarConfiguracion = inicializarConfiguracion;
window.renderConfiguracion = renderConfiguracion;
window.guardarConfiguracion = guardarConfiguracion;
window.descartarCambiosConfiguracion = descartarCambiosConfiguracion;


/* ==========================================
   7ï¸âƒ£ COMPONENTES REUTILIZABLES
   ========================================== */

/* ==========================================
   7.1. DRAG & DROP UNIVERSAL (OPTIMIZADO V2 ðŸš€)
   ========================================== */

// Tracker global para limpiar listeners y evitar memory leaks
const DragDropManager = {
  activeInstances: new Map(), // guarda: tbody.id -> funciÃ³n de limpieza
  
  cleanup(tableBodyId) {
    const cleanup = this.activeInstances.get(tableBodyId);
    if (cleanup) {
      cleanup();
      this.activeInstances.delete(tableBodyId);
    }
  }
};

function enableGenericDragAndDrop(tableBodyId, onReorderCallback) {
  const tbody = document.getElementById(tableBodyId);
  if (!tbody) return;

  // 1. LIMPIEZA PREVIA (CRÃTICO: Elimina los listeners "zombis")
  DragDropManager.cleanup(tableBodyId);

  const rows = tbody.querySelectorAll('tr.draggable-row');
  let dragSrcEl = null;
  let currentDropTarget = null; // Cache para rendimiento

  // FunciÃ³n de limpieza visual
  const limpiarEstilos = () => {
    if (currentDropTarget) {
      currentDropTarget.classList.remove('drop-target');
      currentDropTarget = null;
    }
    const dragging = tbody.querySelector('.dragging');
    if (dragging) dragging.classList.remove('dragging');
  };

  // Array para guardar los "removeEventListener" de esta instancia
  const cleanupFunctions = [];

  rows.forEach(row => {
    // --- LÃ“GICA DE RATÃ“N (PC) ---
    
    const onDragStart = function(e) {
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
      this.classList.add('dragging');
    };

    const onDragEnd = function() {
      this.classList.remove('dragging');
      limpiarEstilos();
    };

    const onDragOver = function(e) {
      if (e.preventDefault) e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      if (dragSrcEl !== this) {
        // OptimizaciÃ³n: Solo tocar el DOM si cambia el target
        if (currentDropTarget !== this) {
          if (currentDropTarget) currentDropTarget.classList.remove('drop-target');
          this.classList.add('drop-target');
          currentDropTarget = this;
        }
      }
      return false;
    };

    const onDragLeave = function() {
      this.classList.remove('drop-target');
      if (currentDropTarget === this) currentDropTarget = null;
    };

    const onDrop = function(e) {
      if (e.stopPropagation) e.stopPropagation();
      limpiarEstilos();

      if (dragSrcEl !== this) {
        const oldIndex = parseInt(dragSrcEl.dataset.index);
        const newIndex = parseInt(this.dataset.index);
        if (typeof onReorderCallback === 'function') {
          onReorderCallback(oldIndex, newIndex);
        }
      }
      return false;
    };

    // AÃ±adir listeners PC
    row.addEventListener('dragstart', onDragStart);
    row.addEventListener('dragend', onDragEnd);
    row.addEventListener('dragover', onDragOver);
    row.addEventListener('dragleave', onDragLeave);
    row.addEventListener('drop', onDrop);

    // Guardar limpiadores PC
    cleanupFunctions.push(() => {
      row.removeEventListener('dragstart', onDragStart);
      row.removeEventListener('dragend', onDragEnd);
      row.removeEventListener('dragover', onDragOver);
      row.removeEventListener('dragleave', onDragLeave);
      row.removeEventListener('drop', onDrop);
    });

    // --- LÃ“GICA TÃCTIL (MÃ“VIL) ---
    
    const handle = row.querySelector('.handle');
    
    if (handle) {
      let touchStartedOnHandle = false;

      const onTouchStart = function(e) {
        // Solo iniciamos si tocamos el handle, permitiendo scroll en el resto
        touchStartedOnHandle = true;
        e.preventDefault(); // Evitar scroll mientras arrastramos el handle
        dragSrcEl = row;
        row.classList.add('dragging');
      };

      const onTouchMove = function(e) {
        if (!touchStartedOnHandle) return;
        
        e.preventDefault(); // Stop scroll
        
        const touch = e.touches[0];
        const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
        const targetRow = targetElement ? targetElement.closest('tr.draggable-row') : null;

        if (targetRow && targetRow !== currentDropTarget && targetRow !== dragSrcEl && tbody.contains(targetRow)) {
          if (currentDropTarget) currentDropTarget.classList.remove('drop-target');
          targetRow.classList.add('drop-target');
          currentDropTarget = targetRow;
        } else if (!targetRow && currentDropTarget) {
          currentDropTarget.classList.remove('drop-target');
          currentDropTarget = null;
        }
      };

      const onTouchEnd = function(e) {
        if (!touchStartedOnHandle) return;
        
        const touch = e.changedTouches[0];
        const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
        const targetRow = targetElement ? targetElement.closest('tr.draggable-row') : null;

        limpiarEstilos();
        row.classList.remove('dragging');
        touchStartedOnHandle = false;

        if (targetRow && targetRow !== dragSrcEl && tbody.contains(targetRow)) {
          const oldIndex = parseInt(dragSrcEl.dataset.index);
          const newIndex = parseInt(targetRow.dataset.index);
          
          if (typeof onReorderCallback === 'function') {
            onReorderCallback(oldIndex, newIndex);
          }
        }
      };

      // AÃ±adir listeners MÃ³vil
      handle.addEventListener('touchstart', onTouchStart, { passive: false });
      handle.addEventListener('touchmove', onTouchMove, { passive: false });
      handle.addEventListener('touchend', onTouchEnd);

      // Guardar limpiadores MÃ³vil
      cleanupFunctions.push(() => {
        handle.removeEventListener('touchstart', onTouchStart);
        handle.removeEventListener('touchmove', onTouchMove);
        handle.removeEventListener('touchend', onTouchEnd);
      });
    }
  });

  // Registrar la limpieza global para este TBODY
  DragDropManager.activeInstances.set(tableBodyId, () => {
    cleanupFunctions.forEach(fn => fn());
  });
}

// âœ… FunciÃ³n segura para mover elementos en array
function arrayMove(arr, oldIndex, newIndex) {
    if (oldIndex < 0 || oldIndex >= arr.length) return arr;
    if (newIndex < 0 || newIndex >= arr.length) return arr;
    
    const item = arr.splice(oldIndex, 1)[0];
    arr.splice(newIndex, 0, item);
    return arr;
}

// Exportar
window.DragDropManager = DragDropManager;
window.enableGenericDragAndDrop = enableGenericDragAndDrop;
window.arrayMove = arrayMove;


/* =========================================================
   7.2. SELECTOR DE ICONOS AVANZADO (ICONIFY INTEGRADO) ðŸŽ¨
   ========================================================= */

// 1. STARTER PACK (Iconos frecuentes para colegios)
const ICON_STARTER_PACK = {
  'General': ['mdi:cube-outline', 'mdi:home', 'mdi:information', 'mdi:star', 'mdi:bell', 'mdi:calendar'],
  'TecnologÃ­a': ['mdi:laptop', 'mdi:tablet', 'mdi:projector', 'mdi:printer', 'mdi:wifi', 'mdi:mouse'],
  'Espacios': ['mdi:door-open', 'mdi:chair-school', 'mdi:blackboard', 'mdi:library', 'mdi:food', 'mdi:flask'],
  'Objetos': ['mdi:cart-outline', 'mdi:book-open-variant', 'mdi:pencil', 'mdi:music-note', 'mdi:basketball', 'mdi:bus']
};

// Variables globales (Declaradas UNA sola vez aquÃ­)
let indexRecursoEditandoIcono = null;
let searchTimeout;

// --- FUNCIONES PRINCIPALES ---

function abrirSelectorIconos(index) {
  indexRecursoEditandoIcono = index;
  const modal = document.getElementById('modalIconPicker');
  
  // Fix Teletransporte (para que se vea encima de todo)
  if (modal.parentNode !== document.body) document.body.appendChild(modal);
  
  // Resetear input y vista
  document.getElementById('searchIconInput').value = '';
  if(typeof renderCategoriasLocales === 'function') renderCategoriasLocales();
  if(typeof renderGridLocal === 'function') renderGridLocal('General'); 
  
  // Mostrar
  modal.classList.remove('hidden');
  setTimeout(() => document.getElementById('searchIconInput').focus(), 50);
}

function cerrarSelectorIconos() {
  document.getElementById('modalIconPicker').classList.add('hidden');
  indexRecursoEditandoIcono = null;
}

// --- RENDERIZADO ---

function renderCategoriasLocales() {
  const catContainer = document.getElementById('iconCategories');
  if(!catContainer) return;

  catContainer.innerHTML = Object.keys(ICON_STARTER_PACK).map(cat => 
    `<button onclick="renderGridLocal('${cat}')" 
             class="px-3 py-1 text-xs font-medium bg-white hover:bg-blue-50 text-gray-600 hover:text-blue-600 rounded-full transition-colors border border-gray-200 shadow-sm">
       ${cat}
     </button>`
  ).join('');
}

function renderGridLocal(category) {
  renderIconsToGrid(ICON_STARTER_PACK[category] || []);
}

function renderIconsToGrid(iconList) {
  const grid = document.getElementById('iconGrid');
  if(!grid) return;
  
  if(iconList.length === 0) {
      grid.innerHTML = `<div class="col-span-full text-center py-8 text-gray-400 text-sm">No se encontraron iconos</div>`;
      return;
  }
  
  grid.innerHTML = iconList.map(icon => {
    const fullName = icon.includes(':') ? icon : `mdi:${icon}`;
    const shortName = fullName.split(':').pop();
    
    return `
      <button onclick="seleccionarIcono('${fullName}')" 
              class="flex flex-col items-center justify-center p-2 bg-white rounded-xl border border-gray-200 hover:border-blue-500 hover:shadow-md transition-all gap-2 group h-20 relative"
              title="${fullName}">
        <iconify-icon icon="${fullName}" class="text-2xl text-gray-500 group-hover:text-blue-600 transition-colors"></iconify-icon>
        <span class="text-[9px] text-gray-400 truncate w-full text-center group-hover:text-blue-500 font-mono">
            ${shortName}
        </span>
      </button>
    `;
  }).join('');
}

// --- BÃšSQUEDA (API ICONIFY) ---

function filtrarIconosGrid() {
  const query = document.getElementById('searchIconInput').value.trim();
  
  // Si estÃ¡ vacÃ­o, volvemos a las categorÃ­as locales
  if (query.length === 0) {
    renderGridLocal('General');
    return;
  }
  
  if (query.length < 3) return;

  // Loading state
  document.getElementById('iconGrid').innerHTML = `
    <div class="col-span-full flex flex-col items-center justify-center py-8 text-gray-400">
      <iconify-icon icon="mdi:loading" class="text-3xl animate-spin mb-2"></iconify-icon>
      <span class="text-xs">Buscando en Iconify...</span>
    </div>
  `;

  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => { buscarEnIconifyAPI(query); }, 500);
}

function buscarEnIconifyAPI(query) {
  // Buscamos solo en MDI (Material Design) para mantener coherencia
  const url = `https://api.iconify.design/search?query=${query}&limit=100`;
  
  fetch(url)
    .then(res => res.json())
    .then(data => {
      if (data.icons && data.icons.length > 0) renderIconsToGrid(data.icons);
      else renderIconsToGrid([]);
    })
    .catch(() => {
        document.getElementById('iconGrid').innerHTML = `<div class="col-span-full text-center text-red-400 text-xs">Error de conexiÃ³n</div>`;
    });
}

// --- SELECCIÃ“N FINAL ---

function seleccionarIcono(iconName) {
  if (indexRecursoEditandoIcono === null || indexRecursoEditandoIcono === undefined) {
    console.error('âŒ No hay Ã­ndice seleccionado');
    cerrarSelectorIconos();
    return;
  }
  
  const index = indexRecursoEditandoIcono;
  
  // Validar que el recurso existe
  if (!AdminState.recursos[index]) {
    console.error(`âŒ Recurso ${index} no existe. Total recursos: ${AdminState.recursos.length}`);
    cerrarSelectorIconos();
    return;
  }
  
  // 1. Actualizar en memoria directamente (sin llamar a editarRecursoInput)
  AdminState.recursos[index].icono = iconName;
  
  // 2. Actualizar visualmente SOLO el icono (cirugÃ­a quirÃºrgica)
  const iconElement = document.querySelector(`button[onclick="abrirSelectorIconos(${index})"] iconify-icon`);
  if (iconElement) {
    iconElement.setAttribute('icon', iconName);
  }
  
  // 3. Marcar cambios pendientes
  if (typeof checkRecursosChanges === 'function') {
    checkRecursosChanges();
  }
  
  // 4. Cerrar modal
  cerrarSelectorIconos();
}

// EXPORTS
window.abrirSelectorIconos = abrirSelectorIconos;
window.cerrarSelectorIconos = cerrarSelectorIconos;
window.filtrarIconosGrid = filtrarIconosGrid;
window.renderGridLocal = renderGridLocal;
window.seleccionarIcono = seleccionarIcono;
window.renderCategoriasLocales = renderCategoriasLocales;


/* =========================================================
   7.3. HELPERS
   ========================================================= */

function setVal(id, val) { 
    const el = document.getElementById(id); 
    if(el) el.value = val !== undefined ? val : ''; 
}
function setCheck(id, val) { 
    const el = document.getElementById(id); 
    if(el) el.checked = (String(val).toLowerCase() === 'true' || val === true || val === 1); 
}
function getVal(id) { return document.getElementById(id).value; }
function getCheck(id) { return document.getElementById(id).checked; }

// âœ… FUNCIÃ“N AUXILIAR: Extraer nÃºmero de tramo
function extraerNumeroTramo(idTramo) {
  if (!idTramo) return 0;
  const match = String(idTramo).match(/\d+/);
  return match ? parseInt(match[0], 10) : 0;
}

/* =========================================================
   8ï¸âƒ£ SISTEMA DE CARGA
   ========================================================= */

/* =========================================================
   8.1. VARIABLES DE CONTROL
   ========================================================= */
var adminDataReady = false;   // Â¿Datos listos?
var adminDataLoading = false; // Â¿Cargando ahora mismo?

/* =========================================================
   8.2. FUNCIÃ“N DE CARGA MAESTRA (Modo Ninja ðŸ¥·)
   ========================================================= */
function loadAdminData(isSilent = false) {
  if (adminDataReady) return; 
  
  adminDataLoading = true;

  if (!isSilent) showLoading(); 

  google.script.run
    .withSuccessHandler(function(data) {
      if (!isSilent) hideLoading(); 
      
      if (!data || !data.success) {
        if (!isSilent) showToast('error', data ? (data.error || 'Error al cargar datos') : 'Error servidor');
        adminDataLoading = false;
        return;
      }

      console.group(isSilent ? "âœ… Precarga Admin Silenciosa Completada" : "âœ… Carga Admin Usuario Completada");

      // --- 1. GUARDAR DATOS ---
      AdminState.recursos = data.recursos || [];
      AdminState.tramos = data.tramos || [];
      AdminState.cursos = data.cursos || [];
      AdminState.usuarios = data.usuarios || [];
      AdminState.reservas = data.reservas || [];
      AdminState.config = data.config || [];
      AdminState.modoVisualizacion = data.modoVisualizacion || 'botones'; // âœ… AÃ‘ADIDO

      // --- 2. COPIAS DE SEGURIDAD ---
      AdminState.recursosOriginales = JSON.parse(JSON.stringify(AdminState.recursos));
      AdminState.usuariosOriginales = JSON.parse(JSON.stringify(AdminState.usuarios));

      // --- 3. DISPONIBILIDAD ---
      const dispCruda = data.disponibilidad || [];
      AdminState.disponibilidad = dispCruda.map(d => ({
          id_recurso: String(d.id_recurso || d.ID_Recurso || '').trim(),
          id_tramo: String(d.id_tramo || d.ID_Tramo || '').trim(),
          dia_semana: String(d.dia_semana || d.Dia_Semana || '').trim(),
          permitido: String(d.permitido || d.Permitido || 'Si').trim(),
          razon_bloqueo: String(d.razon_bloqueo || d.Razon_Bloqueo || '').trim()
      }));

      // --- 4. RENDERIZADO E INICIALIZACIÃ“N ---
      // âŒ ELIMINADO: if(typeof CursosState !== 'undefined') CursosState.modoVisualizacion = data.modoVisualizacion || 'botones';
      
      if (typeof renderTablaRecursos === 'function') renderTablaRecursos();
      if (typeof inicializarRecursos === 'function') inicializarRecursos(); 
      if (typeof inicializarTramos === 'function') inicializarTramos(); 
      if (typeof renderSelectRecursos === 'function') renderSelectRecursos();
      if (typeof inicializarCursos === 'function') inicializarCursos(); 
      if (typeof inicializarUsuarios === 'function') inicializarUsuarios();
      if (typeof renderTablaReservas === 'function') renderTablaReservas();
      if (typeof inicializarConfiguracion === 'function') inicializarConfiguracion();

      // --- 5. FINALIZAR ---
      AdminState.cambiosPendientes = false;
      if (typeof SaveBarManager !== 'undefined') SaveBarManager.hide();

      adminDataReady = true; 
      adminDataLoading = false;

      // --- LÃ“GICA VISUAL FINAL ---
      if (!isSilent && typeof openAdminPanelUI === 'function') {
          openAdminPanelUI();
      } else {
          console.log("âœ… Datos Admin listos en segundo plano (Invisible)");
      }
      
      console.groupEnd();
     })
     .withFailureHandler(function(error) {
      if (!isSilent) {
          hideLoading();
          showToast('error', 'Error de conexiÃ³n: ' + error.message);
      }
      console.warn("âš ï¸ Fallo en precarga silenciosa:", error);
      adminDataLoading = false;
    })
    .getAdminData();
}

/* =========================================================
   8.3. PREFETCH
   ========================================================= */
// Se ejecuta 3 segundos despuÃ©s de entrar en la web
function initAdminPrefetch() {
  setTimeout(() => {
    // Si aÃºn no estÃ¡n listos y no se estÃ¡n cargando...
    if (!adminDataReady && !adminDataLoading) {
       loadAdminData(true); // true = Modo Silencioso (sin spinner)
    }
  }, 3000); 
}

/* =========================================================
   8.4. ðŸ”„ RECARGA INTELIGENTE DE LA APP PRINCIPAL (SILENCIOSA)
   ========================================================= */

/**
 * Recarga datos desde el servidor y actualiza la vista de reservas
 * Se llama automÃ¡ticamente despuÃ©s de guardar cambios en Admin
 */
window.recargarDatosApp = function() {
  console.log('ðŸ”„ Recargando datos de la aplicaciÃ³n principal (silencioso)...');
  
  // Recargar datos del servidor (SIN mostrar spinner ni toast)
  google.script.run
    .withSuccessHandler(function(data) {
      if (data.success) {
        console.log('âœ… Datos recargados correctamente');
        
        // Actualizar globalState (si existe)
        if (typeof globalState !== 'undefined') {
          globalState.recursos = data.recursos || [];
          globalState.tramos = data.tramos || [];
          globalState.cursos = data.cursos || [];
          globalState.usuariosMap = data.usuariosMap || {};
          globalState.modoVisualizacionCursos = data.modoVisualizacionCursos || 'botones';
        }
        
        // Re-renderizar tarjetas de recursos (si existe la funciÃ³n)
        if (typeof renderRecursos === 'function') {
          renderRecursos(data.recursos || []);
        }
      }
    })
    .withFailureHandler(function(error) {
      console.warn('âš ï¸ Error al recargar vista (silencioso):', error);
      // No mostramos nada al usuario, solo log
    })
    .getStaticData();
};

/* =========================================================
   9ï¸âƒ£ EVENTOS GLOBALES Y ARRANQUE
   ========================================================= */

/* =========================================================
   9.1. GESTIÃ“N DE CIERRE DE DROPDOWNS (GLOBAL) ðŸ–±ï¸
   ========================================================= */
document.addEventListener('click', function(e) {
  
  // A. CERRAR DROPDOWNS GENÃ‰RICOS (IDs que empiezan por "dropdown-")
  // Solo cerramos si el click NO fue dentro del propio dropdown ni en su botÃ³n activador
  const dropdowns = document.querySelectorAll('[id^="dropdown-"]:not(.hidden)');
  dropdowns.forEach(drop => {
    // Asumimos que el botÃ³n activador tiene un ID o clase relacionable, 
    // pero para asegurar, cerramos si el click no estÃ¡ dentro del dropdown.
    if (!drop.contains(e.target)) {
       // Nota: Si tus botones no tienen stopPropagation(), esto podrÃ­a cerrar el menÃº 
       // justo al abrirlo. Lo ideal es controlar esto en la funciÃ³n de abrir.
       drop.classList.add('hidden');
    }
  });

  // B. CERRAR EL DROPDOWN ESPECÃFICO DE RECURSOS (Tu cÃ³digo especÃ­fico)
  const dropRecurso = document.getElementById('dropdownRecursoDisp');
  const btnRecurso = document.getElementById('btnSelectorRecursoDisp');
  
  if (dropRecurso && !dropRecurso.classList.contains('hidden')) {
      // Si el click NO fue en el dropdown Y NO fue en el botÃ³n
      if (!dropRecurso.contains(e.target) && !btnRecurso.contains(e.target)) {
          dropRecurso.classList.add('hidden');
      }
  }
});

/* ==========================================
   9.2. FIX: FORZAR MENÃšS FLOTANTES (STICKY)
   Mueve los menÃºs al <body> para que nada les impida flotar
   ========================================== */
function fixMenusFlotantes() {
  const ids = [
    'accionesTramosFlotante', 
    'accionesCursosFlotante', 
    'accionesUsuariosFlotante'
  ];
  
  ids.forEach(id => {
    const elemento = document.getElementById(id);
    if (elemento && elemento.parentNode !== document.body) {
      // Lo arrancamos de su cÃ¡rcel y lo liberamos en el body
      document.body.appendChild(elemento);
    }
  });
}

/* =========================================================
   9.3. INICIALIZACIÃ“N DEL ADMIN ðŸš€
   ========================================================= */
/* =========================================================
   10. GESTIÃ“N DE SOLICITUDES RECURRENTES
   ========================================================= */

let filtroEstadoRecurrente = 'pendiente';

/**
 * Carga las solicitudes recurrentes desde el servidor
 */
async function cargarSolicitudesRecurrentes() {
  const container = document.getElementById('listaSolicitudesRecurrentes');
  if (!container) return;

  container.innerHTML = `
    <div class="text-center py-8">
      <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mx-auto"></div>
      <p class="text-gray-500 mt-2">Cargando solicitudes...</p>
    </div>
  `;

  try {
    const result = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .getSolicitudesRecurrentes();
    });

    if (result.success) {
      AdminState.solicitudesRecurrentes = result.solicitudes || [];
      renderizarSolicitudesRecurrentes();
      actualizarBadgeRecurrentes();
    } else {
      container.innerHTML = `<p class="text-red-500 text-center py-4">${escaparHTML(result.error)}</p>`;
    }
  } catch (error) {
    console.error('Error cargando solicitudes recurrentes:', error);
    container.innerHTML = `<p class="text-red-500 text-center py-4">Error al cargar: ${escaparHTML(error.message)}</p>`;
  }
}

/**
 * Actualiza el badge de solicitudes pendientes
 */
function actualizarBadgeRecurrentes() {
  const badge = document.getElementById('badgeSolicitudesRecurrentes');
  if (!badge) return;

  const pendientes = AdminState.solicitudesRecurrentes.filter(s =>
    (s.estado || '').toLowerCase() === 'pendiente'
  ).length;

  if (pendientes > 0) {
    badge.textContent = pendientes;
    badge.classList.remove('hidden');
  } else {
    badge.classList.add('hidden');
  }
}

/**
 * Filtra solicitudes por estado
 */
function filtrarSolicitudesRecurrentes(estado) {
  filtroEstadoRecurrente = estado;

  // Actualizar botones de filtro
  document.querySelectorAll('[data-filtro-recurrente]').forEach(btn => {
    const btnEstado = btn.dataset.filtroRecurrente;
    if (btnEstado === estado) {
      btn.classList.add('bg-blue-600', 'text-white');
      btn.classList.remove('bg-gray-100', 'text-gray-700');
    } else {
      btn.classList.remove('bg-blue-600', 'text-white');
      btn.classList.add('bg-gray-100', 'text-gray-700');
    }
  });

  renderizarSolicitudesRecurrentes();
}

/**
 * Renderiza las solicitudes recurrentes segÃºn el filtro activo
 */
function renderizarSolicitudesRecurrentes() {
  const container = document.getElementById('listaSolicitudesRecurrentes');
  if (!container) return;

  let solicitudes = AdminState.solicitudesRecurrentes;

  // Aplicar filtro
  if (filtroEstadoRecurrente !== 'todas') {
    solicitudes = solicitudes.filter(s =>
      (s.estado || '').toLowerCase() === filtroEstadoRecurrente.toLowerCase()
    );
  }

  if (solicitudes.length === 0) {
    const mensajes = {
      'pendiente': 'No hay solicitudes pendientes de revisiÃ³n',
      'aprobada': 'No hay solicitudes aprobadas',
      'rechazada': 'No hay solicitudes rechazadas',
      'todas': 'No hay solicitudes registradas'
    };
    container.innerHTML = `
      <div class="text-center py-8 text-gray-500">
        <iconify-icon icon="mdi:calendar-check" class="text-4xl mb-2"></iconify-icon>
        <p>${mensajes[filtroEstadoRecurrente] || 'No hay solicitudes'}</p>
      </div>
    `;
    return;
  }

  // Ordenar por fecha (mÃ¡s recientes primero)
  solicitudes.sort((a, b) => new Date(b.fecha_solicitud) - new Date(a.fecha_solicitud));

  container.innerHTML = solicitudes.map(sol => {
    const estadoClasses = {
      'pendiente': 'bg-amber-100 text-amber-800',
      'aprobada': 'bg-green-100 text-green-800',
      'rechazada': 'bg-red-100 text-red-800'
    };
    const estadoClass = estadoClasses[(sol.estado || '').toLowerCase()] || 'bg-gray-100 text-gray-800';

    const diasMap = { 'L': 'Lun', 'M': 'Mar', 'X': 'MiÃ©', 'J': 'Jue', 'V': 'Vie' };
    const diasFormateados = (sol.dias_semana || '').split(',').map(d => diasMap[d.trim()] || d).join(', ');

    const fechaInicio = sol.fecha_inicio ? new Date(sol.fecha_inicio).toLocaleDateString('es-ES') : 'No especificada';
    const fechaFin = sol.fecha_fin ? new Date(sol.fecha_fin).toLocaleDateString('es-ES') : 'No especificada';

    return `
      <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
        <div class="flex items-start justify-between gap-4">
          <div class="flex-1 min-w-0">
            <div class="flex items-center gap-2 mb-2">
              <span class="font-semibold text-gray-900">${escaparHTML(sol.nombre_recurso)}</span>
              <span class="px-2 py-0.5 text-xs font-medium rounded-full ${estadoClass}">
                ${escaparHTML(sol.estado)}
              </span>
            </div>
            <div class="text-sm text-gray-600 space-y-1">
              <p><span class="font-medium">Solicitante:</span> ${escaparHTML(sol.nombre_usuario)} (${escaparHTML(sol.email_usuario)})</p>
              <p><span class="font-medium">DÃ­as:</span> ${escaparHTML(diasFormateados)} Â· <span class="font-medium">Tramo:</span> ${escaparHTML(sol.nombre_tramo)}</p>
              <p><span class="font-medium">PerÃ­odo:</span> ${fechaInicio} â†’ ${fechaFin}</p>
              <p><span class="font-medium">Motivo:</span> ${escaparHTML(sol.motivo || 'No especificado')}</p>
              ${sol.notas_admin ? `<p class="text-blue-600"><span class="font-medium">Notas admin:</span> ${escaparHTML(sol.notas_admin)}</p>` : ''}
            </div>
          </div>
          <div class="flex flex-col gap-2">
            ${(sol.estado || '').toLowerCase() === 'pendiente' ? `
              <button onclick="abrirModalGestionarSolicitud('${sol.id_solicitud}')"
                class="px-3 py-1.5 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">
                Gestionar
              </button>
            ` : ''}
            <button onclick="verDetalleSolicitud('${sol.id_solicitud}')"
              class="px-3 py-1.5 text-sm font-medium text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-colors">
              Ver detalle
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

/**
 * Abre el modal para gestionar (aprobar/rechazar) una solicitud
 */
function abrirModalGestionarSolicitud(idSolicitud) {
  const solicitud = AdminState.solicitudesRecurrentes.find(s => s.id_solicitud === idSolicitud);
  if (!solicitud) {
    mostrarToast('Solicitud no encontrada', 'error');
    return;
  }

  document.getElementById('gestionarSolicitudId').value = idSolicitud;
  document.getElementById('gestionarSolicitudNotas').value = '';
  document.getElementById('gestionarSolicitudMotivo').value = '';

  // Mostrar info de la solicitud
  const diasMap = { 'L': 'Lunes', 'M': 'Martes', 'X': 'MiÃ©rcoles', 'J': 'Jueves', 'V': 'Viernes' };
  const diasFormateados = (solicitud.dias_semana || '').split(',').map(d => diasMap[d.trim()] || d).join(', ');

  document.getElementById('gestionarSolicitudInfo').innerHTML = `
    <div class="space-y-2 text-sm">
      <p><span class="font-medium text-gray-700">Recurso:</span> ${escaparHTML(solicitud.nombre_recurso)}</p>
      <p><span class="font-medium text-gray-700">Solicitante:</span> ${escaparHTML(solicitud.nombre_usuario)}</p>
      <p><span class="font-medium text-gray-700">DÃ­as:</span> ${escaparHTML(diasFormateados)}</p>
      <p><span class="font-medium text-gray-700">Tramo:</span> ${escaparHTML(solicitud.nombre_tramo)}</p>
      <p><span class="font-medium text-gray-700">PerÃ­odo:</span> ${new Date(solicitud.fecha_inicio).toLocaleDateString('es-ES')} â†’ ${new Date(solicitud.fecha_fin).toLocaleDateString('es-ES')}</p>
      <p><span class="font-medium text-gray-700">Motivo:</span> ${escaparHTML(solicitud.motivo)}</p>
    </div>
  `;

  document.getElementById('modalGestionarSolicitud').classList.remove('hidden');
}

function cerrarModalGestionarSolicitud() {
  document.getElementById('modalGestionarSolicitud').classList.add('hidden');
}

/**
 * Aprueba una solicitud recurrente
 */
async function aprobarSolicitudRecurrente() {
  const idSolicitud = document.getElementById('gestionarSolicitudId').value;
  const notas = document.getElementById('gestionarSolicitudNotas').value.trim();

  const btnAprobar = document.querySelector('#modalGestionarSolicitud button[onclick="aprobarSolicitudRecurrente()"]');
  const textoOriginal = btnAprobar.innerHTML;
  btnAprobar.disabled = true;
  btnAprobar.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>Aprobando...';

  try {
    const result = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .aprobarSolicitudRecurrente(idSolicitud, notas);
    });

    if (result.success) {
      mostrarToast(`Solicitud aprobada. Se generaron ${result.reservasGeneradas || 0} reservas.`, 'success');
      cerrarModalGestionarSolicitud();
      cargarSolicitudesRecurrentes();
      adminHaCambiadoDatos = true;
    } else {
      mostrarToast(result.error || 'Error al aprobar', 'error');
    }
  } catch (error) {
    console.error('Error al aprobar:', error);
    mostrarToast('Error al aprobar la solicitud: ' + error.message, 'error');
  } finally {
    btnAprobar.disabled = false;
    btnAprobar.innerHTML = textoOriginal;
  }
}

/**
 * Rechaza una solicitud recurrente
 */
async function rechazarSolicitudRecurrente() {
  const idSolicitud = document.getElementById('gestionarSolicitudId').value;
  const motivo = document.getElementById('gestionarSolicitudMotivo').value.trim();

  if (!motivo) {
    mostrarToast('Debes indicar un motivo para rechazar', 'error');
    return;
  }

  const btnRechazar = document.querySelector('#modalGestionarSolicitud button[onclick="rechazarSolicitudRecurrente()"]');
  const textoOriginal = btnRechazar.innerHTML;
  btnRechazar.disabled = true;
  btnRechazar.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>Rechazando...';

  try {
    const result = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .rechazarSolicitudRecurrente(idSolicitud, motivo);
    });

    if (result.success) {
      mostrarToast('Solicitud rechazada correctamente', 'success');
      cerrarModalGestionarSolicitud();
      cargarSolicitudesRecurrentes();
    } else {
      mostrarToast(result.error || 'Error al rechazar', 'error');
    }
  } catch (error) {
    console.error('Error al rechazar:', error);
    mostrarToast('Error al rechazar la solicitud: ' + error.message, 'error');
  } finally {
    btnRechazar.disabled = false;
    btnRechazar.innerHTML = textoOriginal;
  }
}

/**
 * Muestra detalle de una solicitud (histÃ³rico)
 */
function verDetalleSolicitud(idSolicitud) {
  const solicitud = AdminState.solicitudesRecurrentes.find(s => s.id_solicitud === idSolicitud);
  if (!solicitud) {
    mostrarToast('Solicitud no encontrada', 'error');
    return;
  }

  const diasMap = { 'L': 'Lunes', 'M': 'Martes', 'X': 'MiÃ©rcoles', 'J': 'Jueves', 'V': 'Viernes' };
  const diasFormateados = (solicitud.dias_semana || '').split(',').map(d => diasMap[d.trim()] || d).join(', ');

  const estadoClasses = {
    'pendiente': 'text-amber-600',
    'aprobada': 'text-green-600',
    'rechazada': 'text-red-600'
  };
  const estadoClass = estadoClasses[(solicitud.estado || '').toLowerCase()] || 'text-gray-600';

  let html = `
    <div class="space-y-3">
      <div class="flex items-center gap-2">
        <span class="font-bold text-lg">${escaparHTML(solicitud.nombre_recurso)}</span>
        <span class="font-semibold ${estadoClass}">(${escaparHTML(solicitud.estado)})</span>
      </div>
      <hr>
      <p><strong>ID:</strong> ${escaparHTML(solicitud.id_solicitud)}</p>
      <p><strong>Solicitante:</strong> ${escaparHTML(solicitud.nombre_usuario)} (${escaparHTML(solicitud.email_usuario)})</p>
      <p><strong>DÃ­as:</strong> ${escaparHTML(diasFormateados)}</p>
      <p><strong>Tramo:</strong> ${escaparHTML(solicitud.nombre_tramo)}</p>
      <p><strong>PerÃ­odo:</strong> ${new Date(solicitud.fecha_inicio).toLocaleDateString('es-ES')} â†’ ${new Date(solicitud.fecha_fin).toLocaleDateString('es-ES')}</p>
      <p><strong>Motivo:</strong> ${escaparHTML(solicitud.motivo || 'No especificado')}</p>
      <p><strong>Fecha solicitud:</strong> ${new Date(solicitud.fecha_solicitud).toLocaleString('es-ES')}</p>
      ${solicitud.fecha_resolucion ? `<p><strong>Fecha resoluciÃ³n:</strong> ${new Date(solicitud.fecha_resolucion).toLocaleString('es-ES')}</p>` : ''}
      ${solicitud.admin_resolutor ? `<p><strong>Gestionado por:</strong> ${escaparHTML(solicitud.admin_resolutor)}</p>` : ''}
      ${solicitud.notas_admin ? `<p><strong>Notas admin:</strong> ${escaparHTML(solicitud.notas_admin)}</p>` : ''}
    </div>
  `;

  // Usar un modal simple o alert
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
  modal.innerHTML = `
    <div class="bg-white rounded-xl shadow-xl max-w-lg w-full p-6 max-h-[80vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-900">Detalle de Solicitud</h3>
        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
          <iconify-icon icon="mdi:close" class="text-xl"></iconify-icon>
        </button>
      </div>
      ${html}
      <div class="mt-6 text-right">
        <button onclick="this.closest('.fixed').remove()"
          class="px-4 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 rounded-lg">
          Cerrar
        </button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

/**
 * Abre modal para crear reserva recurrente directa (admin)
 */
function abrirModalRecurrenteDirecta() {
  // Poblar selector de recursos
  const selectRecurso = document.getElementById('recDirectaRecurso');
  selectRecurso.innerHTML = '<option value="">Selecciona un recurso</option>';
  AdminState.recursos.forEach(r => {
    if (r.estado === 'Activo') {
      selectRecurso.innerHTML += `<option value="${r.id_recurso}">${escaparHTML(r.nombre)}</option>`;
    }
  });

  // Poblar selector de tramos
  const selectTramo = document.getElementById('recDirectaTramo');
  selectTramo.innerHTML = '<option value="">Selecciona un tramo</option>';
  AdminState.tramos.forEach(t => {
    selectTramo.innerHTML += `<option value="${t.id_tramo}">${escaparHTML(t.nombre_tramo)} (${t.hora_inicio} - ${t.hora_fin})</option>`;
  });

  // Poblar selector de usuarios
  const selectUsuario = document.getElementById('recDirectaUsuario');
  selectUsuario.innerHTML = '<option value="">Selecciona un usuario</option>';
  const usuariosActivos = AdminState.usuarios.filter(u => u.activo === true || u.activo === 'TRUE');
  usuariosActivos.forEach(u => {
    selectUsuario.innerHTML += `<option value="${u.email_usuario}">${escaparHTML(u.nombre_completo)} (${u.email_usuario})</option>`;
  });

  // Resetear campos
  document.querySelectorAll('input[name="recDirectaDias"]').forEach(cb => cb.checked = false);
  document.getElementById('recDirectaFechaInicio').value = new Date().toISOString().split('T')[0];
  document.getElementById('recDirectaFechaFin').value = '';
  document.getElementById('recDirectaNotas').value = '';

  document.getElementById('modalRecurrenteDirecta').classList.remove('hidden');
}

function cerrarModalRecurrenteDirecta() {
  document.getElementById('modalRecurrenteDirecta').classList.add('hidden');
}

/**
 * Guarda una reserva recurrente directa (sin solicitud previa)
 */
async function guardarRecurrenteDirecta() {
  const recurso = document.getElementById('recDirectaRecurso').value;
  const tramo = document.getElementById('recDirectaTramo').value;
  const usuario = document.getElementById('recDirectaUsuario').value;
  const fechaInicio = document.getElementById('recDirectaFechaInicio').value;
  const fechaFin = document.getElementById('recDirectaFechaFin').value;
  const notas = document.getElementById('recDirectaNotas').value.trim();

  const diasSeleccionados = [];
  document.querySelectorAll('input[name="recDirectaDias"]:checked').forEach(cb => {
    diasSeleccionados.push(cb.value);
  });

  // Validaciones
  if (!recurso) return mostrarToast('Selecciona un recurso', 'error');
  if (!tramo) return mostrarToast('Selecciona un tramo', 'error');
  if (!usuario) return mostrarToast('Selecciona un usuario', 'error');
  if (diasSeleccionados.length === 0) return mostrarToast('Selecciona al menos un dÃ­a', 'error');
  if (!fechaFin) return mostrarToast('Indica la fecha de fin', 'error');

  const btn = document.querySelector('#modalRecurrenteDirecta button[onclick="guardarRecurrenteDirecta()"]');
  const textoOriginal = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="animate-spin inline-block w-4 h-4 border-2 border-white border-t-transparent rounded-full mr-2"></span>Generando...';

  try {
    const datos = {
      id_recurso: recurso,
      id_tramo: tramo,
      email_usuario: usuario,
      dias_semana: diasSeleccionados,
      fecha_inicio: fechaInicio,
      fecha_fin: fechaFin,
      notas_admin: notas
    };

    const result = await new Promise((resolve, reject) => {
      google.script.run
        .withSuccessHandler(resolve)
        .withFailureHandler(reject)
        .crearRecurrenteDirecta(datos);
    });

    if (result.success) {
      mostrarToast(`Reservas generadas: ${result.reservasGeneradas || 0}`, 'success');
      cerrarModalRecurrenteDirecta();
      cargarSolicitudesRecurrentes();
      adminHaCambiadoDatos = true;
    } else {
      mostrarToast(result.error || 'Error al crear reservas', 'error');
    }
  } catch (error) {
    console.error('Error al crear recurrente directa:', error);
    mostrarToast('Error: ' + error.message, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = textoOriginal;
  }
}

/* =========================================================
   9.3. INICIALIZACIÃ“N DEL ADMIN ðŸš€
   ========================================================= */
document.addEventListener('DOMContentLoaded', function() {

  // 1. Configurar los Listeners (Clicks de pestaÃ±as, botones de guardar, etc.)
  if (typeof setupAdminListeners === 'function') {
      setupAdminListeners();
  }

  // 2. LANZAR LA ESTRATEGIA DE "CARGA INTELIGENTE" (Prefetch)
  // No llamamos a loadAdminData() directamente para no bloquear.
  // Llamamos a initAdminPrefetch() para que cargue en silencio.
  if (typeof initAdminPrefetch === 'function') {
      initAdminPrefetch();
  } else {
      // Fallback: Si no existe la precarga, cargamos normal
      console.warn("No se encontrÃ³ initAdminPrefetch, cargando datos estÃ¡ndar...");
      if(typeof loadAdminData === 'function') loadAdminData(false);
  }
});


</script>